<body>
  <div class="app">
    <aside class="sidebar">
      <div class="sb-top">
        <button class="iconbtn" title="–ú–µ–Ω—é" aria-label="–ú–µ–Ω—é">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
            <path d="M4 6h16M4 12h16M4 18h16"/>
          </svg>
        </button>

        <div class="brand">
          <span class="logo" aria-hidden="true"></span>
          <span>BioConsult</span>
        </div>

        <button class="iconbtn" title="–ü–æ—à—É–∫" aria-label="–ü–æ—à—É–∫">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
            <circle cx="11" cy="11" r="7"></circle>
            <path d="M20 20l-3.2-3.2"></path>
          </svg>
        </button>
      </div>

      <button class="newchat" id="newChatBtn">
        <span class="badge"></span>
        <span>–ù–æ–≤–∏–π –¥—ñ–∞–ª–æ–≥</span>
      </button>

      <div class="sb-section"><span>–ë–∞–∑–∞ –∑–Ω–∞–Ω—å (RAG)</span><span style="opacity:.7" id="kbCount">0 —Ñ–∞–π–ª—ñ–≤</span></div>
      <div class="sb-list" id="kbList"></div>

      <div class="sb-footer">üß¨ –ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –∑ –±—ñ–æ–ª–æ–≥—ñ—ó ‚Ä¢ RAG —É –±—Ä–∞—É–∑–µ—Ä—ñ</div>
    </aside>

    <main class="main" id="main">
      <header class="topbar">
        <div class="pill" id="apiPill" title="–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è LLM">
          ‚öô API: <strong id="apiState">–Ω–µ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ</strong>
        </div>
        <div style="display:flex; align-items:center; gap:10px;">
          <button class="pill" id="ragToggleBtn" aria-pressed="true">üß† RAG: —É–≤—ñ–º–∫–Ω–µ–Ω–æ</button>
          <div class="avatar" title="–ü—Ä–æ—Ñ—ñ–ª—å"></div>
        </div>
      </header>

      <section class="content">
        <div class="hero">
          <div class="hello">
            <span class="leafMark" aria-hidden="true"></span>
            <span>–ü—Ä–∏–≤—ñ—Ç! –Ø BioConsult</span>
          </div>
          <h1 class="title">–ù–∞–≤—á–∞–π –º–µ–Ω–µ —Å–≤–æ—ó–º–∏ –º–∞—Ç–µ—Ä—ñ–∞–ª–∞–º–∏ ‚Äî —ñ —è –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—Ç–∏–º—É —Ç–æ—á–Ω—ñ—à–µ</h1>
          <div class="subtitle">
            –ù–∞—Ç–∏—Å–Ω–∏ ‚Äú+‚Äù ‚Üí –¥–æ–¥–∞–π .txt/.md (—Ü–µ –±—É–¥–µ –±–∞–∑–∞ –∑–Ω–∞–Ω—å). –ü–æ—Ç—ñ–º —Å—Ç–∞–≤ –∑–∞–ø–∏—Ç–∞–Ω–Ω—è ‚Äî
            —è –∑–Ω–∞–π–¥—É —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ñ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∏ —ñ –≤—ñ–¥–ø–æ–≤—ñ–º —á–µ—Ä–µ–∑ LLM, –ø–æ–∫–∞–∑–∞–≤—à–∏ –¥–∂–µ—Ä–µ–ª–∞.
          </div>
        </div>

        <div class="chatlog" id="chatLog" aria-live="polite"></div>
      </section>

      <div class="composer-wrap">
        <div class="composer-area">
          <div class="composer" id="composer">
            <!-- PLUS MENU -->
            <div class="plusMenu" id="plusMenu" role="menu" aria-label="–ú–µ–Ω—é –¥–æ–¥–∞–≤–∞–Ω–Ω—è">
              <div class="pmTitle">
                <span>–î–æ–¥–∞—Ç–∏</span>
                <button class="iconbtn" id="closePlusMenu" title="–ó–∞–∫—Ä–∏—Ç–∏" aria-label="–ó–∞–∫—Ä–∏—Ç–∏" style="width:32px;height:32px;">‚úï</button>
              </div>
              <div class="pmGrid">
                <button class="pmBtn" id="pmAddImageFile" type="button">
                  <div class="l">üñºÔ∏è –î–æ–¥–∞—Ç–∏ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è (—Ñ–∞–π–ª)</div>
                  <div class="r">jpg/png/webp</div>
                </button>
                <button class="pmBtn" id="pmAddImageUrl" type="button">
                  <div class="l">‚òÅÔ∏è –î–æ–¥–∞—Ç–∏ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∑ —Ö–º–∞—Ä–∏ (URL)</div>
                  <div class="r">–ø–æ—Å–∏–ª–∞–Ω–Ω—è</div>
                </button>
                <button class="pmBtn" id="pmAddTextFile" type="button">
                  <div class="l">üìÑ –î–æ–¥–∞—Ç–∏ –º–∞—Ç–µ—Ä—ñ–∞–ª (.txt/.md)</div>
                  <div class="r">–Ω–∞–≤—á–∏—Ç–∏ RAG</div>
                </button>
                <button class="pmBtn" id="pmClearKB" type="button">
                  <div class="l">üßΩ –û—á–∏—Å—Ç–∏—Ç–∏ –±–∞–∑—É –∑–Ω–∞–Ω—å</div>
                  <div class="r">RAG</div>
                </button>
                <button class="pmBtn" id="pmClearChat" type="button">
                  <div class="l">üßπ –û—á–∏—Å—Ç–∏—Ç–∏ —á–∞—Ç</div>
                  <div class="r">—Å–∫–∏–Ω—É—Ç–∏</div>
                </button>
              </div>
              <div class="tiny">–ü–æ—Ä–∞–¥–∞: –¥–æ–¥–∞–π –∫—ñ–ª—å–∫–∞ –∫–æ–Ω—Å–ø–µ–∫—Ç—ñ–≤ .txt/.md ‚Äî –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ —Å—Ç–∞–Ω—É—Ç—å ‚Äú–ø—ñ–¥ —Ç–≤–æ—é –ø—Ä–æ–≥—Ä–∞–º—É‚Äù.</div>
            </div>

            <div class="composer-row">
              <button class="plus" id="plusBtn" title="–î–æ–¥–∞—Ç–∏" aria-label="–î–æ–¥–∞—Ç–∏">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                  <path d="M12 5v14M5 12h14"/>
                </svg>
              </button>

              <div class="input">
                <textarea id="prompt" placeholder="–ó–∞–ø–∏—Ç–∞–π—Ç–µ BioConsult‚Ä¶" rows="1"></textarea>
              </div>

              <div class="tools">
                <button class="send" id="sendBtn" title="–ù–∞–¥—ñ—Å–ª–∞—Ç–∏" aria-label="–ù–∞–¥—ñ—Å–ª–∞—Ç–∏">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M5 12h14"></path>
                    <path d="M13 5l7 7-7 7"></path>
                  </svg>
                </button>
              </div>
            </div>

            <div class="chips" id="chips">
              <div class="chip">üåø –ü–æ—è—Å–Ω–∏ —Ñ–æ—Ç–æ—Å–∏–Ω—Ç–µ–∑</div>
              <div class="chip">üß¨ –©–æ —Ç–∞–∫–µ —Ä–µ–ø–ª—ñ–∫–∞—Ü—ñ—è –î–ù–ö?</div>
              <div class="chip">ü¶† –†—ñ–∑–Ω–∏—Ü—è –≤—ñ—Ä—É—Å/–±–∞–∫—Ç–µ—Ä—ñ—è</div>
              <div class="chip">üß† –ú—ñ—Ç–æ–∑ vs –º–µ–π–æ–∑</div>
            </div>

            <div class="hint">
              <span>Enter ‚Äî –Ω–∞–¥—ñ—Å–ª–∞—Ç–∏ ‚Ä¢ Shift+Enter ‚Äî –Ω–æ–≤–∏–π —Ä—è–¥–æ–∫ ‚Ä¢ ‚Äú+‚Äù ‚Äî –º–∞—Ç–µ—Ä—ñ–∞–ª–∏/–∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è</span>
              <span id="statusText">–ì–æ—Ç–æ–≤–æ</span>
            </div>

            <!-- hidden inputs -->
            <input id="imageInput" type="file" accept="image/*" hidden />
            <input id="textInput" type="file" accept=".txt,.md,text/plain,text/markdown" hidden />
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- MODAL: Image URL -->
  <div class="modalOverlay" id="imgModalOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="–î–æ–¥–∞—Ç–∏ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∑–∞ URL">
      <h3>–î–æ–¥–∞—Ç–∏ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∑ —Ö–º–∞—Ä–∏ (URL)</h3>
      <p>–í—Å—Ç–∞–≤ –ø—Ä—è–º–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è (–∞–±–æ –ø—É–±–ª—ñ—á–Ω–∏–π URL). –Ø–∫—â–æ –¥–æ—Å—Ç—É–ø –∑–∞–∫—Ä–∏—Ç–∏–π ‚Äî –±—Ä–∞—É–∑–µ—Ä/LLM –Ω–µ –∑–º–æ–∂–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏.</p>
      <div class="row">
        <input id="imgUrlInput" placeholder="https://..." />
      </div>
      <div class="modalActions">
        <button class="btn" id="cancelImgModal">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
        <button class="btn primary" id="addUrlBtn">–î–æ–¥–∞—Ç–∏</button>
      </div>
    </div>
  </div>

  <!-- MODAL: API SETTINGS -->
  <div class="modalOverlay" id="apiModalOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è API">
      <h3>–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è LLM API</h3>
      <p>
        –í—Å—Ç–∞–≤ API key —ñ –º–æ–¥–µ–ª—å. –¶–µ –ø–æ—Ç—Ä—ñ–±–Ω–æ, —â–æ–± –±–æ—Ç –≤—ñ–¥–ø–æ–≤—ñ–¥–∞–≤ ‚Äú–ø–æ-—Å–ø—Ä–∞–≤–∂–Ω—å–æ–º—É‚Äù.
        (–ö–ª—é—á –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –≤ –±—Ä–∞—É–∑–µ—Ä—ñ.)
      </p>

      <div class="row">
        <input id="apiKeyInput" placeholder="OpenAI API key (sk-...)" />
      </div>

      <div class="row">
        <input id="modelInput" placeholder="–ú–æ–¥–µ–ª—å (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: gpt-4o-mini)" />
      </div>

      <div class="tiny">
        –Ø–∫—â–æ –º–æ–¥–µ–ª—å –Ω–µ –ø—Ä–∞—Ü—é—î ‚Äî –∑–∞–º—ñ–Ω–∏ –Ω–∞–∑–≤—É (–≤ –∞–∫–∞—É–Ω—Ç—ñ –º–æ–∂—É—Ç—å –±—É—Ç–∏ –¥–æ—Å—Ç—É–ø–Ω—ñ —ñ–Ω—à—ñ –º–æ–¥–µ–ª—ñ).
      </div>

      <div class="modalActions">
        <button class="btn" id="apiCancel">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
        <button class="btn" id="apiClear">–û—á–∏—Å—Ç–∏—Ç–∏</button>
        <button class="btn primary" id="apiSave">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
      </div>
    </div>
  </div>

  <script>
    /***********************
     * UI refs
     ***********************/
    const promptEl = document.getElementById('prompt');
    const sendBtn  = document.getElementById('sendBtn');
    const chatLog  = document.getElementById('chatLog');
    const chips    = document.getElementById('chips');
    const newChatBtn = document.getElementById('newChatBtn');
    const statusText = document.getElementById('statusText');

    const ragToggleBtn = document.getElementById('ragToggleBtn');
    const apiPill = document.getElementById('apiPill');
    const apiState = document.getElementById('apiState');

    const plusBtn = document.getElementById('plusBtn');
    const plusMenu = document.getElementById('plusMenu');
    const closePlusMenu = document.getElementById('closePlusMenu');

    const pmAddImageFile = document.getElementById('pmAddImageFile');
    const pmAddImageUrl  = document.getElementById('pmAddImageUrl');
    const pmAddTextFile  = document.getElementById('pmAddTextFile');
    const pmClearChat    = document.getElementById('pmClearChat');
    const pmClearKB      = document.getElementById('pmClearKB');

    const imageInput = document.getElementById('imageInput');
    const textInput  = document.getElementById('textInput');

    const imgModalOverlay = document.getElementById('imgModalOverlay');
    const imgUrlInput = document.getElementById('imgUrlInput');
    const cancelImgModal = document.getElementById('cancelImgModal');
    const addUrlBtn = document.getElementById('addUrlBtn');

    const apiModalOverlay = document.getElementById('apiModalOverlay');
    const apiKeyInput = document.getElementById('apiKeyInput');
    const modelInput = document.getElementById('modelInput');
    const apiCancel = document.getElementById('apiCancel');
    const apiClear = document.getElementById('apiClear');
    const apiSave = document.getElementById('apiSave');

    const kbList = document.getElementById('kbList');
    const kbCount = document.getElementById('kbCount');

    let ragEnabled = true;
    let busy = false;

    // attachments for current message
    let pendingImageDataUrl = null; // data:image/... base64 OR normal URL
    let pendingImageLabel = null;

    function setStatus(t){ statusText.textContent = t; }

    function autoResize() {
      promptEl.style.height = "24px";
      promptEl.style.height = Math.min(promptEl.scrollHeight, 120) + "px";
    }
    promptEl.addEventListener('input', autoResize);

    /***********************
     * Chat render
     ***********************/
    function addMsg(text, who="user", sources=[]) {
      const div = document.createElement('div');
      div.className = `msg ${who}`;
      div.textContent = text;

      if (who === "bot" && Array.isArray(sources) && sources.length) {
        const s = document.createElement('div');
        s.className = "sources";
        s.textContent = "–î–∂–µ—Ä–µ–ª–∞ (RAG):";

        sources.forEach(src => {
          const item = document.createElement('div');
          item.className = "src";

          const t = document.createElement('div');
          t.className = "t";
          t.textContent = src.title || "–î–∂–µ—Ä–µ–ª–æ";

          const sn = document.createElement('div');
          sn.className = "s";
          sn.textContent = src.snippet || "";

          item.appendChild(t);
          item.appendChild(sn);
          s.appendChild(item);
        });

        div.appendChild(s);
      }

      chatLog.appendChild(div);
      chatLog.scrollTop = chatLog.scrollHeight;
    }

    function addImagePreviewMessage({ dataUrl, caption, who="user" }){
      const div = document.createElement('div');
      div.className = `msg ${who}`;
      div.textContent = caption || "–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è –¥–æ–¥–∞–Ω–æ:";

      const wrap = document.createElement('div');
      wrap.className = "imgwrap";
      const img = document.createElement('img');
      img.src = dataUrl;
      img.alt = "image";
      wrap.appendChild(img);
      div.appendChild(wrap);

      chatLog.appendChild(div);
      chatLog.scrollTop = chatLog.scrollHeight;
    }

    /***********************
     * Plus menu
     ***********************/
    function openMenu(){ plusMenu.classList.add("open"); }
    function closeMenu(){ plusMenu.classList.remove("open"); }

    plusBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      plusMenu.classList.contains("open") ? closeMenu() : openMenu();
    });
    closePlusMenu.addEventListener('click', closeMenu);

    document.addEventListener('click', (e) => {
      if (!plusMenu.contains(e.target) && e.target !== plusBtn) closeMenu();
    });

    pmAddImageFile.addEventListener('click', () => { closeMenu(); imageInput.click(); });
    pmAddTextFile.addEventListener('click', () => { closeMenu(); textInput.click(); });
    pmAddImageUrl.addEventListener('click', () => { closeMenu(); openImgModal(); });

    pmClearChat.addEventListener('click', () => {
      closeMenu();
      chatLog.innerHTML = "";
      addMsg("–ß–∞—Ç –æ—á–∏—â–µ–Ω–æ ‚úÖ", "bot");
      setStatus("–ì–æ—Ç–æ–≤–æ");
    });

    pmClearKB.addEventListener('click', () => {
      closeMenu();
      if (!confirm("–û—á–∏—Å—Ç–∏—Ç–∏ –±–∞–∑—É –∑–Ω–∞–Ω—å (–≤—Å—ñ –º–∞—Ç–µ—Ä—ñ–∞–ª–∏)?")) return;
      KB.clear();
      RAG.rebuildIndexFromKB();
      renderKB();
      addMsg("–ë–∞–∑—É –∑–Ω–∞–Ω—å –æ—á–∏—â–µ–Ω–æ ‚úÖ", "bot");
      setStatus("–ì–æ—Ç–æ–≤–æ");
    });

    /***********************
     * Image modal
     ***********************/
    function openImgModal(){
      imgModalOverlay.classList.add("open");
      imgModalOverlay.setAttribute("aria-hidden","false");
      imgUrlInput.value = "";
      setTimeout(() => imgUrlInput.focus(), 0);
    }
    function closeImgModal(){
      imgModalOverlay.classList.remove("open");
      imgModalOverlay.setAttribute("aria-hidden","true");
    }
    cancelImgModal.addEventListener('click', closeImgModal);
    imgModalOverlay.addEventListener('click', (e) => { if(e.target === imgModalOverlay) closeImgModal(); });

    addUrlBtn.addEventListener('click', async () => {
      const url = (imgUrlInput.value || "").trim();
      if(!url) return;

      pendingImageDataUrl = url;
      pendingImageLabel = "–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è (URL)";
      addMsg("‚úÖ –î–æ–¥–∞–Ω–æ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∑ URL. –¢–µ–ø–µ—Ä –∑–∞–¥–∞–π –ø–∏—Ç–∞–Ω–Ω—è –ø—Ä–æ –Ω—å–æ–≥–æ.", "bot");
      closeImgModal();
    });

    /***********************
     * API modal
     ***********************/
    function openApiModal(){
      apiModalOverlay.classList.add("open");
      apiModalOverlay.setAttribute("aria-hidden","false");
      apiKeyInput.value = Settings.getApiKey() || "";
      modelInput.value = Settings.getModel() || "gpt-4o-mini";
      setTimeout(() => apiKeyInput.focus(), 0);
    }
    function closeApiModal(){
      apiModalOverlay.classList.remove("open");
      apiModalOverlay.setAttribute("aria-hidden","true");
    }
    apiPill.addEventListener('click', openApiModal);
    apiCancel.addEventListener('click', closeApiModal);

    apiClear.addEventListener('click', () => {
      Settings.clear();
      updateApiState();
      addMsg("API –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –æ—á–∏—â–µ–Ω–æ.", "bot");
      closeApiModal();
    });

    apiSave.addEventListener('click', () => {
      const key = (apiKeyInput.value || "").trim();
      const model = (modelInput.value || "").trim() || "gpt-4o-mini";
      Settings.setApiKey(key);
      Settings.setModel(model);
      updateApiState();
      addMsg("‚úÖ API –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∑–±–µ—Ä–µ–∂–µ–Ω–æ. –ú–æ–∂–Ω–∞ —Å–ø—ñ–ª–∫—É–≤–∞—Ç–∏—Å—å.", "bot");
      closeApiModal();
    });

    /***********************
     * RAG toggle
     ***********************/
    ragToggleBtn.addEventListener('click', () => {
      ragEnabled = !ragEnabled;
      ragToggleBtn.textContent = ragEnabled ? "üß† RAG: —É–≤—ñ–º–∫–Ω–µ–Ω–æ" : "üß† RAG: –≤–∏–º–∫–Ω–µ–Ω–æ";
      ragToggleBtn.setAttribute("aria-pressed", String(ragEnabled));
      setStatus(ragEnabled ? "RAG —É–≤—ñ–º–∫–Ω–µ–Ω–æ" : "RAG –≤–∏–º–∫–Ω–µ–Ω–æ");
    });

    /***********************
     * Inputs
     ***********************/
    imageInput.addEventListener('change', async () => {
      const file = imageInput.files?.[0];
      if(!file) return;

      if(!file.type.startsWith("image/")){
        addMsg("‚ùå –¶–µ –Ω–µ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è.", "bot");
        imageInput.value = "";
        return;
      }

      const dataUrl = await fileToDataURL(file);
      pendingImageDataUrl = dataUrl;
      pendingImageLabel = file.name;

      addImagePreviewMessage({ dataUrl, caption:`–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è –¥–æ–¥–∞–Ω–æ: ${file.name}`, who:"user" });
      addMsg("–¢–µ–ø–µ—Ä –º–æ–∂–µ—à –Ω–∞–ø–∏—Å–∞—Ç–∏ –ø–∏—Ç–∞–Ω–Ω—è –ø—Ä–æ —Ü–µ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: ‚Äú—â–æ —Ç—É—Ç –∑ —Ç–æ—á–∫–∏ –∑–æ—Ä—É –±—ñ–æ–ª–æ–≥—ñ—ó?‚Äù).", "bot");

      imageInput.value = "";
    });

    textInput.addEventListener('change', async () => {
      const file = textInput.files?.[0];
      if(!file) return;
      const text = await file.text();

      KB.addDoc({ title: file.name, text });
      RAG.rebuildIndexFromKB();
      renderKB();

      addMsg(`‚úÖ –î–æ–¥–∞–Ω–æ –º–∞—Ç–µ—Ä—ñ–∞–ª –¥–æ –±–∞–∑–∏ –∑–Ω–∞–Ω—å: ${file.name}`, "bot");
      setStatus("–ë–∞–∑—É –æ–Ω–æ–≤–ª–µ–Ω–æ");

      textInput.value = "";
    });

    /***********************
     * Chips & new chat
     ***********************/
    chips.addEventListener('click', (e) => {
      const chip = e.target.closest('.chip');
      if(!chip) return;
      promptEl.value = chip.textContent.replace(/\s+/g,' ').trim() + ": ";
      promptEl.focus();
      autoResize();
    });

    newChatBtn.addEventListener('click', () => {
      chatLog.innerHTML = "";
      promptEl.value = "";
      autoResize();
      promptEl.focus();
      setStatus("–ì–æ—Ç–æ–≤–æ");
      closeMenu();
    });

    /***********************
     * Send
     ***********************/
    sendBtn.addEventListener('click', send);
    promptEl.addEventListener('keydown', (e) => {
      if(e.key === "Enter" && !e.shiftKey){
        e.preventDefault();
        send();
      }
    });

    async function send(){
      const text = (promptEl.value || "").trim();
      if(!text || busy) return;

      busy = true;
      setStatus("–ü–∏—à—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å‚Ä¶");
      sendBtn.disabled = true;

      addMsg(text, "user");
      promptEl.value = "";
      autoResize();

      try{
        const apiKey = Settings.getApiKey();
        const model = Settings.getModel() || "gpt-4o-mini";

        if(!apiKey){
          addMsg("‚ö†Ô∏è API –Ω–µ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ. –ù–∞—Ç–∏—Å–Ω–∏ ‚Äú‚öô API‚Äù —ñ –≤—Å—Ç–∞–≤ –∫–ª—é—á, —Ç–æ–¥—ñ —è –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—Ç–∏–º—É —Ä–µ–∞–ª—å–Ω–æ.", "bot");
          setStatus("–ü–æ—Ç—Ä—ñ–±–µ–Ω API key");
          return;
        }

        const contexts = ragEnabled ? RAG.retrieveTopK(text, 4) : [];
        const { answer, sources } = await LLM.answer({
          apiKey,
          model,
          userText: text,
          contexts,
          image: pendingImageDataUrl ? { url: pendingImageDataUrl, label: pendingImageLabel } : null
        });

        addMsg(answer || "–ù–µ–º–∞—î –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ", "bot", sources);

        // reset attachments after send
        pendingImageDataUrl = null;
        pendingImageLabel = null;

        setStatus("–ì–æ—Ç–æ–≤–æ");
      }catch(err){
        addMsg("‚ùå –ü–æ–º–∏–ª–∫–∞: " + (err?.message || String(err)), "bot");
        setStatus("–ü–æ–º–∏–ª–∫–∞");
      }finally{
        busy = false;
        sendBtn.disabled = false;
      }
    }

    /***********************
     * Settings storage
     ***********************/
    const Settings = {
      kApiKey: "bioconsult_api_key",
      kModel: "bioconsult_model",
      getApiKey(){ return localStorage.getItem(this.kApiKey) || ""; },
      setApiKey(v){ localStorage.setItem(this.kApiKey, v || ""); },
      getModel(){ return localStorage.getItem(this.kModel) || ""; },
      setModel(v){ localStorage.setItem(this.kModel, v || ""); },
      clear(){
        localStorage.removeItem(this.kApiKey);
        localStorage.removeItem(this.kModel);
      }
    };

    function updateApiState(){
      const hasKey = !!Settings.getApiKey();
      apiState.textContent = hasKey ? "–Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ" : "–Ω–µ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ";
    }

    /***********************
     * KB storage (docs)
     ***********************/
    const KB = {
      key: "bioconsult_kb_docs",
      getAll(){
        try { return JSON.parse(localStorage.getItem(this.key) || "[]"); }
        catch { return []; }
      },
      setAll(docs){
        localStorage.setItem(this.key, JSON.stringify(docs || []));
      },
      addDoc(doc){
        const docs = this.getAll();
        docs.push({
          id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random(),
          title: doc.title || "doc.txt",
          text: doc.text || "",
          createdAt: Date.now()
        });
        this.setAll(docs);
      },
      remove(id){
        const docs = this.getAll().filter(d => d.id !== id);
        this.setAll(docs);
      },
      clear(){ this.setAll([]); }
    };

    function renderKB(){
      const docs = KB.getAll();
      kbCount.textContent = `${docs.length} —Ñ–∞–π–ª—ñ–≤`;
      kbList.innerHTML = "";

      if(docs.length === 0){
        const empty = document.createElement("div");
        empty.className = "sb-item";
        empty.textContent = "–î–æ–¥–∞–π .txt/.md —á–µ—Ä–µ–∑ ‚Äú+‚Äù";
        kbList.appendChild(empty);
        return;
      }

      docs.slice().reverse().forEach(d => {
        const row = document.createElement("div");
        row.className = "sb-item";
        row.title = "–ù–∞—Ç–∏—Å–Ω–∏, —â–æ–± –≤–∏–¥–∞–ª–∏—Ç–∏";

        const dot = document.createElement("span");
        dot.className = "badge";
        dot.style.width = "10px";
        dot.style.height = "10px";
        dot.style.boxShadow = "none";
        row.appendChild(dot);

        const name = document.createElement("div");
        name.textContent = d.title;
        name.style.flex = "1";
        row.appendChild(name);

        const del = document.createElement("span");
        del.textContent = "üóëÔ∏è";
        del.style.opacity = ".75";
        row.appendChild(del);

        row.addEventListener("click", () => {
          if(!confirm(`–í–∏–¥–∞–ª–∏—Ç–∏ "${d.title}" –∑ –±–∞–∑–∏?`)) return;
          KB.remove(d.id);
          RAG.rebuildIndexFromKB();
          renderKB();
          addMsg(`‚úÖ –í–∏–¥–∞–ª–µ–Ω–æ –∑ –±–∞–∑–∏: ${d.title}`, "bot");
        });

        kbList.appendChild(row);
      });
    }

    /***********************
     * RAG in browser (TF-IDF-ish)
     ***********************/
    const RAG = (() => {
      let chunks = [];     // {title, text, vec}
      let stats = null;    // {df, N}

      function tokenize(text) {
        return (text || "")
          .toLowerCase()
          .replace(/[^\p{L}\p{N}\s]+/gu, " ")
          .split(/\s+/)
          .filter(Boolean);
      }

      function chunkText(text, chunkSize = 900, overlap = 120) {
        const clean = (text || "").replace(/\s+/g, " ").trim();
        if (!clean) return [];
        const out = [];
        let i = 0;
        while (i < clean.length) {
          const end = Math.min(clean.length, i + chunkSize);
          out.push(clean.slice(i, end));
          i = end - overlap;
          if (i < 0) i = 0;
          if (end === clean.length) break;
        }
        return out;
      }

      function buildVocabStats(chunks) {
        const df = Object.create(null);
        for (const ch of chunks) {
          const seen = new Set(tokenize(ch.text));
          for (const t of seen) df[t] = (df[t] || 0) + 1;
        }
        return { df, N: chunks.length };
      }

      function embed(text, stats) {
        const toks = tokenize(text);
        const tf = Object.create(null);
        for (const t of toks) tf[t] = (tf[t] || 0) + 1;

        const vec = Object.create(null);
        const { df, N } = stats || { df:{}, N:1 };
        for (const [t, f] of Object.entries(tf)) {
          const d = df[t] || 0;
          const idf = Math.log((N + 1) / (d + 1)) + 1;
          vec[t] = f * idf;
        }
        return vec;
      }

      function cosine(a, b) {
        let dot = 0, na = 0, nb = 0;
        const keys = new Set([...Object.keys(a), ...Object.keys(b)]);
        for (const k of keys) {
          const x = a[k] || 0;
          const y = b[k] || 0;
          dot += x * y;
          na += x * x;
          nb += y * y;
        }
        if (!na || !nb) return 0;
        return dot / (Math.sqrt(na) * Math.sqrt(nb));
      }

      function rebuildIndexFromKB(){
        const docs = KB.getAll();
        chunks = [];
        for (const d of docs) {
          const parts = chunkText(d.text);
          parts.forEach((p, idx) => {
            chunks.push({ title: d.title, text: p, id: `${d.title}#${idx}` });
          });
        }
        stats = buildVocabStats(chunks);
        chunks.forEach(ch => ch.vec = embed(ch.text, stats));
      }

      function retrieveTopK(question, k=4){
        if(!stats || !chunks.length) return [];
        const qvec = embed(question, stats);
        const scored = chunks.map(ch => ({ ch, score: cosine(qvec, ch.vec) }));
        scored.sort((a,b)=>b.score-a.score);
        return scored.slice(0, k).filter(x => x.score > 0.05).map(x => x.ch);
      }

      return { rebuildIndexFromKB, retrieveTopK };
    })();

    /***********************
     * LLM call (OpenAI Responses API)
     ***********************/
    const LLM = (() => {
      function buildSystem(){
        return [
          "–¢–∏ ‚Äî BioConsult, –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –∑ –±—ñ–æ–ª–æ–≥—ñ—ó.",
          "–í—ñ–¥–ø–æ–≤—ñ–¥–∞–π —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é, –ø—Ä–æ—Å—Ç–æ —ñ —Ç–æ—á–Ω–æ.",
          "–Ø–∫—â–æ —î RAG-–∫–æ–Ω—Ç–µ–∫—Å—Ç ‚Äî –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π –π–æ–≥–æ –≤ –ø–µ—Ä—à—É —á–µ—Ä–≥—É.",
          "–Ø–∫—â–æ –¥–∞–Ω–∏—Ö –Ω–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ ‚Äî —Å–∫–∞–∂–∏, —â–æ —Å–∞–º–µ –ø–æ—Ç—Ä—ñ–±–Ω–æ —É—Ç–æ—á–Ω–∏—Ç–∏.",
          "–î–æ–¥–∞–π –∫–æ—Ä–æ—Ç–∫–∏–π –±–ª–æ–∫ '–î–∂–µ—Ä–µ–ª–∞' –∑ –ø–æ–∑–Ω–∞—á–∫–∞–º–∏ [#1], [#2] (—Ç—ñ–ª—å–∫–∏ —è–∫—â–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞–≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç)."
        ].join("\\n");
      }

      function buildContextBlock(contexts){
        if(!contexts?.length) return "";
        return contexts.map((c, i) => `[#${i+1} ${c.title}] ${c.text}`).join("\\n\\n");
      }

      function sourcesFromContexts(contexts){
        return (contexts || []).map(c => ({
          title: c.title,
          snippet: (c.text || "").slice(0, 200) + ((c.text || "").length > 200 ? "‚Ä¶" : "")
        }));
      }

      function extractOutputText(data){
        if (typeof data?.output_text === "string" && data.output_text) return data.output_text;

        const out = data?.output;
        if (Array.isArray(out)) {
          for (const item of out) {
            const content = item?.content;
            if (Array.isArray(content)) {
              for (const c of content) {
                if (c?.type === "output_text" && typeof c?.text === "string") return c.text;
                if (c?.type === "text" && typeof c?.text === "string") return c.text;
              }
            }
          }
        }
        return "";
      }

      async function answer({ apiKey, model, userText, contexts, image }){
        const system = buildSystem();
        const ctx = buildContextBlock(contexts);

        const userParts = [];
        userParts.push({ type:"text", text: userText });

        if (image?.url) {
          userParts.push({ type:"text", text: `\\n(–î–æ–¥–∞–Ω–æ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è: ${image.label || "image"})\\n` });
          userParts.push({ type:"image_url", image_url: { url: image.url } });
        }

        if (ctx) {
          userParts.push({ type:"text", text: `\\n\\n–ö–æ–Ω—Ç–µ–∫—Å—Ç (RAG):\\n${ctx}` });
        }

        const body = {
          model: model || "gpt-4o-mini",
          input: [
            { role:"system", content:[{ type:"text", text: system }] },
            { role:"user", content: userParts }
          ]
        };

        const res = await fetch("https://api.openai.com/v1/responses", {
          method:"POST",
          headers:{
            "Content-Type":"application/json",
            "Authorization":"Bearer " + apiKey
          },
          body: JSON.stringify(body)
        });

        if(!res.ok){
          const t = await res.text();
          throw new Error(t || ("HTTP " + res.status));
        }

        const data = await res.json();
        const text = extractOutputText(data) || "(–ø–æ—Ä–æ–∂–Ω—è –≤—ñ–¥–ø–æ–≤—ñ–¥—å)";

        return { answer: text, sources: sourcesFromContexts(contexts) };
      }

      return { answer };
    })();

    /***********************
     * Helpers
     ***********************/
    function fileToDataURL(file){
      return new Promise((resolve, reject) => {
        const r = new FileReader();
        r.onload = () => resolve(r.result);
        r.onerror = reject;
        r.readAsDataURL(file);
      });
    }

    /***********************
     * Init
     ***********************/
    function init(){
      updateApiState();
      renderKB();
      RAG.rebuildIndexFromKB();
      autoResize();
      setStatus("–ì–æ—Ç–æ–≤–æ");
    }
    init();
  </script>
</body>
</html>
