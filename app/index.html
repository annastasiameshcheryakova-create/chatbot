<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BioConsult ‚Äî Pastel RAG Chat (Offline)</title>

  <style>
    :root{
      --bg:#f6fbf8;
      --panel:#ffffffcc;
      --muted:#7a8f86;
      --text:#24332d;
      --line:#e4efe9;

      --accent:#9fc9b4;
      --accent-soft:#edf6f2;
      --accent-strong:#86b8a1;

      --shadow: 0 12px 30px rgba(0,0,0,.06);
      --r:18px;
      --rLg:26px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background:
        radial-gradient(900px 500px at 80% 0%, #eaf4ef, transparent 60%),
        radial-gradient(700px 450px at 10% 10%, #f2f8f5, transparent 55%),
        var(--bg);
    }

    .app{ height:100dvh; display:grid; grid-template-columns: 320px 1fr; }

    /* Sidebar */
    .sidebar{
      background:rgba(255,255,255,.65);
      backdrop-filter: blur(14px);
      border-right:1px solid var(--line);
      padding:14px 12px;
      display:flex;
      flex-direction:column;
      min-width:280px;
    }
    .sb-top{ display:flex; align-items:center; justify-content:space-between; padding:6px 6px 10px; }
    .brand{ display:flex;align-items:center;gap:10px; font-weight:780; letter-spacing:-.2px; }
    .logo{
      width:30px;height:30px;border-radius:10px;
      background: linear-gradient(135deg, #cfe6dc, #b6d8c9);
      box-shadow:0 6px 14px rgba(134,184,161,.35);
    }
    .iconbtn{
      width:38px;height:38px;border-radius:999px;
      border:1px solid transparent;
      background:transparent;
      cursor:pointer;
      display:grid;place-items:center;
      color:#203127;
    }
    .iconbtn:hover{ background:rgba(0,0,0,.05); }

    .newchat{
      margin:6px;
      display:flex;align-items:center;gap:10px;
      padding:10px 12px;
      border-radius:999px;
      background:var(--panel);
      border:1px solid var(--line);
      cursor:pointer;
      box-shadow:0 1px 0 rgba(0,0,0,.03);
    }
    .badge{
      width:12px;height:12px;border-radius:50%;
      background:var(--accent-strong);
      box-shadow:0 0 0 6px rgba(159,201,180,.25);
    }
    .sb-section{
      margin:10px 6px 6px;
      font-size:13px;
      color:var(--muted);
      display:flex;align-items:center;justify-content:space-between;
      padding:6px 4px;
    }
    .sb-list{ padding:6px; overflow:auto; flex:1; }
    .sb-item{
      padding:10px 10px;
      border-radius:14px;
      font-size:14px;
      color:#233528;
      cursor:pointer;
      display:flex;align-items:center;gap:10px;
    }
    .sb-item:hover{ background:var(--accent-soft); }
    .sb-footer{
      border-top:1px solid var(--line);
      padding:10px 6px 6px;
      font-size:13px;
      color:var(--muted);
      display:flex;align-items:center;gap:8px;
    }

    /* Main */
    .main{ position:relative; display:flex; flex-direction:column; min-width:0; }
    .topbar{
      height:64px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:12px 18px;
      gap:12px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.75);
      backdrop-filter: blur(10px);
      box-shadow:0 1px 0 rgba(0,0,0,.02);
      font-size:13px;
      color:#40574e;
      white-space:nowrap;
      user-select:none;
    }
    .avatar{
      width:36px;height:36px;border-radius:999px;
      background:linear-gradient(135deg,#f1faf6,#ffffff);
      border:1px solid var(--line);
    }

    .content{
      flex:1;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      padding:10px 18px 170px;
      min-height:0;
    }

    .hero{ width:min(900px, 100%); padding:10px 8px 16px; }
    .hello{
      font-size:18px;
      font-weight:650;
      display:flex;
      align-items:center;
      gap:10px;
      color:#1f2f26;
      margin-bottom:8px;
    }
    .leafMark{
      width:22px;height:22px;
      background: linear-gradient(135deg, #cfe6dc, #9fc9b4);
      border-radius:7px;
      transform: rotate(10deg);
    }
    .title{
      font-size:40px;
      font-weight:820;
      letter-spacing:-.6px;
      line-height:1.12;
      margin:0;
      color:#1f2e28;
    }
    .subtitle{
      margin-top:10px;
      max-width:78ch;
      color:var(--muted);
      font-size:15px;
      line-height:1.45;
    }

    /* Chat */
    .chatlog{
      width:min(900px, 100%);
      margin-top:14px;
      display:flex;
      flex-direction:column;
      gap:10px;
      max-height:48vh;
      overflow:auto;
      padding:0 8px 8px;
    }
    .msg{
      max-width:78ch;
      padding:12px 14px;
      border-radius:16px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.75);
      backdrop-filter: blur(10px);
      box-shadow:0 1px 0 rgba(0,0,0,.02);
      white-space:pre-wrap;
      line-height:1.35;
      font-size:15px;
    }
    .msg.user{
      align-self:flex-end;
      background:#eef7f3;
      border-color:#d6ebe2;
    }
    .msg.bot{ align-self:flex-start; }

    .msg .imgwrap{
      margin-top:10px;
      border-radius:14px;
      overflow:hidden;
      border:1px solid var(--line);
      background:#fff;
    }
    .msg img{
      display:block;
      max-width:100%;
      height:auto;
    }

    /* Composer */
    .composer-wrap{
      position:absolute;
      left:0; right:0; bottom:0;
      padding:18px;
      display:flex;
      justify-content:center;
      background:linear-gradient(to top, rgba(246,251,248,1), rgba(246,251,248,.7), rgba(246,251,248,0));
      pointer-events:none;
    }
    .composer-area{ width:min(920px, 100%); pointer-events:auto; }

    .composer{
      border-radius: var(--rLg);
      border:1px solid #dcebe4;
      background:rgba(255,255,255,.82);
      backdrop-filter: blur(14px);
      box-shadow: var(--shadow);
      padding:10px;
      position:relative;
    }

    .composer-row{ display:flex; align-items:center; gap:10px; }

    .plus{
      width:38px;height:38px;border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      cursor:pointer;
      display:grid;place-items:center;
      color:#3b4d46;
      position:relative;
    }
    .plus:hover{ background:var(--accent-soft); border-color:#cfe6dc; }

    .input{
      flex:1;
      display:flex;
      align-items:center;
      gap:10px;
      padding:8px 10px;
      border-radius:999px;
      background:#ffffff;
      border:1px solid #dcebe4;
      min-width:0;
    }
    .input textarea{
      width:100%;
      border:0;
      outline:none;
      resize:none;
      background:transparent;
      font-size:15px;
      line-height:1.35;
      height:24px;
      max-height:120px;
      color:var(--text);
    }

    .tools{ display:flex; align-items:center; gap:8px; flex:0 0 auto; }

    .send{
      width:40px;height:40px;border-radius:999px;
      border:1px solid #9fc9b4;
      background: linear-gradient(180deg, #b8dccc, #9fc9b4);
      color:white;
      cursor:pointer;
      display:grid;place-items:center;
      box-shadow:0 8px 18px rgba(159,201,180,.35);
    }
    .send:hover{ filter:brightness(1.03); }

    .chips{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      padding:12px 8px 0;
    }
    .chip{
      background:var(--accent-soft);
      border:1px solid #cfe6dc;
      border-radius:999px;
      padding:10px 14px;
      font-size:14px;
      color:#355349;
      cursor:pointer;
      user-select:none;
    }
    .chip:hover{ background:#e3f1ea; }

    .hint{
      width:min(920px, 100%);
      padding:6px 8px 0;
      color:var(--muted);
      font-size:12px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }

    /* Plus menu */
    .plusMenu{
      position:absolute;
      left:12px;
      bottom:92px;
      width:340px;
      border-radius:16px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.92);
      backdrop-filter: blur(14px);
      box-shadow: var(--shadow);
      padding:10px;
      display:none;
      z-index:50;
    }
    .plusMenu.open{ display:block; }

    .pmTitle{
      font-size:12px;
      color:var(--muted);
      padding:6px 8px 10px;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .pmGrid{ display:grid; grid-template-columns: 1fr; gap:8px; }

    .pmBtn{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:#fff;
      cursor:pointer;
      text-align:left;
    }
    .pmBtn:hover{ background:var(--accent-soft); border-color:#cfe6dc; }
    .pmBtn .l{ display:flex; align-items:center; gap:10px; color:#2f463d; font-size:14px; font-weight:600; }
    .pmBtn .r{ color:var(--muted); font-size:12px; }

    /* Modal */
    .modalOverlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.25);
      display:none;
      z-index:1000;
    }
    .modalOverlay.open{ display:block; }
    .modal{
      width:min(560px, calc(100% - 24px));
      margin:70px auto;
      border-radius:18px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.96);
      backdrop-filter: blur(16px);
      box-shadow: var(--shadow);
      padding:14px;
    }
    .modal h3{ margin:6px 6px 10px; font-size:16px; color:#203127; }
    .modal p{ margin:0 6px 10px; color:var(--muted); font-size:13px; line-height:1.35; }
    .modal .row{ display:flex; gap:10px; padding:6px; align-items:center; flex-wrap:wrap; }
    .modal input{
      flex:1;
      border-radius:12px;
      border:1px solid var(--line);
      padding:10px 12px;
      outline:none;
      font-size:14px;
      min-width: 240px;
    }
    .modalActions{
      display:flex;
      justify-content:flex-end;
      gap:10px;
      padding:6px;
      margin-top:6px;
      flex-wrap:wrap;
    }
    .btn{
      border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      padding:10px 12px;
      cursor:pointer;
      font-size:13px;
      color:#2f463d;
    }
    .btn.primary{
      border-color:#b8dccc;
      background:linear-gradient(180deg,#e7f4ee,#d7eee5);
    }

    .tiny{
      font-size:12px;
      color:var(--muted);
      padding: 0 6px 10px;
      line-height: 1.35;
    }

    @media (max-width: 920px){
      .app{ grid-template-columns: 1fr; }
      .sidebar{ display:none; }
      .title{ font-size:34px; }
      .plusMenu{ left:18px; right:18px; width:auto; }
    }
  </style>
</head>

<body>
  <div class="app">
    <aside class="sidebar">
      <div class="sb-top">
        <button class="iconbtn" title="–ú–µ–Ω—é" aria-label="–ú–µ–Ω—é">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
            <path d="M4 6h16M4 12h16M4 18h16"/>
          </svg>
        </button>

        <div class="brand">
          <span class="logo" aria-hidden="true"></span>
          <span>BioConsult</span>
        </div>

        <button class="iconbtn" title="–ü–æ—à—É–∫" aria-label="–ü–æ—à—É–∫">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
            <circle cx="11" cy="11" r="7"></circle>
            <path d="M20 20l-3.2-3.2"></path>
          </svg>
        </button>
      </div>

      <button class="newchat" id="newChatBtn">
        <span class="badge"></span>
        <span>–ù–æ–≤–∏–π –¥—ñ–∞–ª–æ–≥</span>
      </button>

      <div class="sb-section"><span>–ë–∞–∑–∞ –∑–Ω–∞–Ω—å (RAG)</span><span style="opacity:.7" id="kbCount">0 —Ñ–∞–π–ª—ñ–≤</span></div>
      <div class="sb-list" id="kbList"></div>

      <div class="sb-footer">üß¨ –ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –∑ –±—ñ–æ–ª–æ–≥—ñ—ó ‚Ä¢ –ª–æ–∫–∞–ª—å–Ω–∞ –±–∞–∑–∞</div>
    </aside>

    <main class="main" id="main">
      <header class="topbar">
        <div class="pill" style="cursor:default">üß¨ BioConsult</div>
        <div style="display:flex; align-items:center; gap:10px;">
          <button class="pill" id="ragToggleBtn" aria-pressed="true" style="cursor:pointer">üß† RAG: —É–≤—ñ–º–∫–Ω–µ–Ω–æ</button>
          <div class="avatar" title="–ü—Ä–æ—Ñ—ñ–ª—å"></div>
        </div>
      </header>

      <section class="content">
        <div class="hero">
          <div class="hello">
            <span class="leafMark" aria-hidden="true"></span>
            <span>–ü—Ä–∏–≤—ñ—Ç! –Ø BioConsult</span>
          </div>
          <h1 class="title">–ù–∞–≤—á–∞–π –º–µ–Ω–µ —Å–≤–æ—ó–º–∏ –º–∞—Ç–µ—Ä—ñ–∞–ª–∞–º–∏ ‚Äî —ñ —è –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—Ç–∏–º—É —Ç–æ—á–Ω—ñ—à–µ</h1>
          <div class="subtitle">
            –ù–∞—Ç–∏—Å–Ω–∏ ‚Äú+‚Äù ‚Üí –¥–æ–¥–∞–π .txt/.md (—Ü–µ –±—É–¥–µ –±–∞–∑–∞ –∑–Ω–∞–Ω—å). –ü–æ—Ç—ñ–º —Å—Ç–∞–≤ –∑–∞–ø–∏—Ç–∞–Ω–Ω—è ‚Äî
            —è –∑–Ω–∞–π–¥—É —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–µ —É —Ç–≤–æ—ó–π –±–∞–∑—ñ —Ç–∞ —Å—Ñ–æ—Ä–º—É—é –≤—ñ–¥–ø–æ–≤—ñ–¥—å –ø—Ä–æ—Å—Ç–∏–º–∏ —Å–ª–æ–≤–∞–º–∏ (–±–µ–∑ –ø–æ–∫–∞–∑—É –∫–æ–Ω—Å–ø–µ–∫—Ç—ñ–≤).
          </div>
        </div>

        <div class="chatlog" id="chatLog" aria-live="polite"></div>
      </section>

      <div class="composer-wrap">
        <div class="composer-area">
          <div class="composer" id="composer">
            <!-- PLUS MENU -->
            <div class="plusMenu" id="plusMenu" role="menu" aria-label="–ú–µ–Ω—é –¥–æ–¥–∞–≤–∞–Ω–Ω—è">
              <div class="pmTitle">
                <span>–î–æ–¥–∞—Ç–∏</span>
                <button class="iconbtn" id="closePlusMenu" title="–ó–∞–∫—Ä–∏—Ç–∏" aria-label="–ó–∞–∫—Ä–∏—Ç–∏" style="width:32px;height:32px;">‚úï</button>
              </div>
              <div class="pmGrid">
                <button class="pmBtn" id="pmAddImageFile" type="button">
                  <div class="l">üñºÔ∏è –î–æ–¥–∞—Ç–∏ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è (—Ñ–∞–π–ª)</div>
                  <div class="r">jpg/png/webp</div>
                </button>
                <button class="pmBtn" id="pmAddImageUrl" type="button">
                  <div class="l">‚òÅÔ∏è –î–æ–¥–∞—Ç–∏ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∑ URL</div>
                  <div class="r">–ø–æ—Å–∏–ª–∞–Ω–Ω—è</div>
                </button>
                <button class="pmBtn" id="pmAddTextFile" type="button">
                  <div class="l">üìÑ –î–æ–¥–∞—Ç–∏ –º–∞—Ç–µ—Ä—ñ–∞–ª (.txt/.md)</div>
                  <div class="r">–≤ –±–∞–∑—É</div>
                </button>
                <button class="pmBtn" id="pmClearKB" type="button">
                  <div class="l">üßΩ –û—á–∏—Å—Ç–∏—Ç–∏ –±–∞–∑—É –∑–Ω–∞–Ω—å</div>
                  <div class="r">RAG</div>
                </button>
                <button class="pmBtn" id="pmClearChat" type="button">
                  <div class="l">üßπ –û—á–∏—Å—Ç–∏—Ç–∏ —á–∞—Ç</div>
                  <div class="r">—Å–∫–∏–Ω—É—Ç–∏</div>
                </button>
              </div>
              <div class="tiny">–ü–æ—Ä–∞–¥–∞: –¥–æ–¥–∞–π –∫—ñ–ª—å–∫–∞ –∫–æ–Ω—Å–ø–µ–∫—Ç—ñ–≤ .txt/.md ‚Äî –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ —Å—Ç–∞–Ω—É—Ç—å ‚Äú–ø—ñ–¥ —Ç–≤–æ—é –ø—Ä–æ–≥—Ä–∞–º—É‚Äù.</div>
            </div>

            <div class="composer-row">
              <button class="plus" id="plusBtn" title="–î–æ–¥–∞—Ç–∏" aria-label="–î–æ–¥–∞—Ç–∏">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                  <path d="M12 5v14M5 12h14"/>
                </svg>
              </button>

              <div class="input">
                <textarea id="prompt" placeholder="–ó–∞–ø–∏—Ç–∞–π—Ç–µ BioConsult‚Ä¶" rows="1"></textarea>
              </div>

              <div class="tools">
                <button class="send" id="sendBtn" title="–ù–∞–¥—ñ—Å–ª–∞—Ç–∏" aria-label="–ù–∞–¥—ñ—Å–ª–∞—Ç–∏">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M5 12h14"></path>
                    <path d="M13 5l7 7-7 7"></path>
                  </svg>
                </button>
              </div>
            </div>

            <div class="chips" id="chips">
              <div class="chip">üåø –ü–æ—è—Å–Ω–∏ —Ñ–æ—Ç–æ—Å–∏–Ω—Ç–µ–∑</div>
              <div class="chip">üß¨ –©–æ —Ç–∞–∫–µ —Ä–µ–ø–ª—ñ–∫–∞—Ü—ñ—è –î–ù–ö?</div>
              <div class="chip">ü¶† –†—ñ–∑–Ω–∏—Ü—è –≤—ñ—Ä—É—Å/–±–∞–∫—Ç–µ—Ä—ñ—è</div>
              <div class="chip">üß† –ú—ñ—Ç–æ–∑ vs –º–µ–π–æ–∑</div>
            </div>

            <div class="hint">
              <span>Enter ‚Äî –Ω–∞–¥—ñ—Å–ª–∞—Ç–∏ ‚Ä¢ Shift+Enter ‚Äî –Ω–æ–≤–∏–π —Ä—è–¥–æ–∫ ‚Ä¢ ‚Äú+‚Äù ‚Äî –º–∞—Ç–µ—Ä—ñ–∞–ª–∏/–∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è</span>
              <span id="statusText">–ì–æ—Ç–æ–≤–æ</span>
            </div>

            <!-- hidden inputs -->
            <input id="imageInput" type="file" accept="image/*" hidden />
            <input id="textInput" type="file" accept=".txt,.md,text/plain,text/markdown" hidden />
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- MODAL: Image URL -->
  <div class="modalOverlay" id="imgModalOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="–î–æ–¥–∞—Ç–∏ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∑–∞ URL">
      <h3>–î–æ–¥–∞—Ç–∏ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∑ URL</h3>
      <p>–í—Å—Ç–∞–≤ –ø—Ä—è–º–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è (–∞–±–æ –ø—É–±–ª—ñ—á–Ω–∏–π URL).</p>
      <div class="row">
        <input id="imgUrlInput" placeholder="https://..." />
      </div>
      <div class="modalActions">
        <button class="btn" id="cancelImgModal">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
        <button class="btn primary" id="addUrlBtn">–î–æ–¥–∞—Ç–∏</button>
      </div>
    </div>
  </div>

  <script>
    /***********************
     * UI refs
     ***********************/
    const promptEl = document.getElementById('prompt');
    const sendBtn  = document.getElementById('sendBtn');
    const chatLog  = document.getElementById('chatLog');
    const chips    = document.getElementById('chips');
    const newChatBtn = document.getElementById('newChatBtn');
    const statusText = document.getElementById('statusText');

    const ragToggleBtn = document.getElementById('ragToggleBtn');

    const plusBtn = document.getElementById('plusBtn');
    const plusMenu = document.getElementById('plusMenu');
    const closePlusMenu = document.getElementById('closePlusMenu');

    const pmAddImageFile = document.getElementById('pmAddImageFile');
    const pmAddImageUrl  = document.getElementById('pmAddImageUrl');
    const pmAddTextFile  = document.getElementById('pmAddTextFile');
    const pmClearChat    = document.getElementById('pmClearChat');
    const pmClearKB      = document.getElementById('pmClearKB');

    const imageInput = document.getElementById('imageInput');
    const textInput  = document.getElementById('textInput');

    const imgModalOverlay = document.getElementById('imgModalOverlay');
    const imgUrlInput = document.getElementById('imgUrlInput');
    const cancelImgModal = document.getElementById('cancelImgModal');
    const addUrlBtn = document.getElementById('addUrlBtn');

    const kbList = document.getElementById('kbList');
    const kbCount = document.getElementById('kbCount');

    let ragEnabled = true;
    let pendingImageDataUrl = null;
    let pendingImageLabel = null;

    function setStatus(t){ statusText.textContent = t; }

    function autoResize() {
      promptEl.style.height = "24px";
      promptEl.style.height = Math.min(promptEl.scrollHeight, 120) + "px";
    }
    promptEl.addEventListener('input', autoResize);

    /***********************
     * Chat render
     ***********************/
    function addMsg(text, who="user") {
      const div = document.createElement('div');
      div.className = `msg ${who}`;
      div.textContent = text;
      chatLog.appendChild(div);
      chatLog.scrollTop = chatLog.scrollHeight;
    }

    function addImagePreviewMessage({ dataUrl, caption, who="user" }){
      const div = document.createElement('div');
      div.className = `msg ${who}`;
      div.textContent = caption || "–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è –¥–æ–¥–∞–Ω–æ:";

      const wrap = document.createElement('div');
      wrap.className = "imgwrap";
      const img = document.createElement('img');
      img.src = dataUrl;
      img.alt = "image";
      wrap.appendChild(img);
      div.appendChild(wrap);

      chatLog.appendChild(div);
      chatLog.scrollTop = chatLog.scrollHeight;
    }

    /***********************
     * Plus menu
     ***********************/
    function openMenu(){ plusMenu.classList.add("open"); }
    function closeMenu(){ plusMenu.classList.remove("open"); }

    plusBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      plusMenu.classList.contains("open") ? closeMenu() : openMenu();
    });
    closePlusMenu.addEventListener('click', closeMenu);

    document.addEventListener('click', (e) => {
      if (!plusMenu.contains(e.target) && e.target !== plusBtn) closeMenu();
    });

    pmAddImageFile.addEventListener('click', () => { closeMenu(); imageInput.click(); });
    pmAddTextFile.addEventListener('click', () => { closeMenu(); textInput.click(); });
    pmAddImageUrl.addEventListener('click', () => { closeMenu(); openImgModal(); });

    pmClearChat.addEventListener('click', () => {
      closeMenu();
      chatLog.innerHTML = "";
      addMsg("–ß–∞—Ç –æ—á–∏—â–µ–Ω–æ ‚úÖ", "bot");
      setStatus("–ì–æ—Ç–æ–≤–æ");
    });

    pmClearKB.addEventListener('click', () => {
      closeMenu();
      if (!confirm("–û—á–∏—Å—Ç–∏—Ç–∏ –±–∞–∑—É –∑–Ω–∞–Ω—å (–≤—Å—ñ –º–∞—Ç–µ—Ä—ñ–∞–ª–∏)?")) return;
      KB.clear();
      RAG.rebuildIndexFromKB();
      renderKB();
      addMsg("–ë–∞–∑—É –∑–Ω–∞–Ω—å –æ—á–∏—â–µ–Ω–æ ‚úÖ", "bot");
      setStatus("–ì–æ—Ç–æ–≤–æ");
    });

    /***********************
     * Image modal
     ***********************/
    function openImgModal(){
      imgModalOverlay.classList.add("open");
      imgModalOverlay.setAttribute("aria-hidden","false");
      imgUrlInput.value = "";
      setTimeout(() => imgUrlInput.focus(), 0);
    }
    function closeImgModal(){
      imgModalOverlay.classList.remove("open");
      imgModalOverlay.setAttribute("aria-hidden","true");
    }
    cancelImgModal.addEventListener('click', closeImgModal);
    imgModalOverlay.addEventListener('click', (e) => { if(e.target === imgModalOverlay) closeImgModal(); });

    addUrlBtn.addEventListener('click', async () => {
      const url = (imgUrlInput.value || "").trim();
      if(!url) return;

      pendingImageDataUrl = url;
      pendingImageLabel = "–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è (URL)";
      addMsg("‚úÖ –ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è –¥–æ–¥–∞–Ω–æ. –ú–æ–∂–µ—à –ø–æ—Å—Ç–∞–≤–∏—Ç–∏ –ø–∏—Ç–∞–Ω–Ω—è –ø—Ä–æ –Ω—å–æ–≥–æ.", "bot");
      closeImgModal();
    });

    /***********************
     * RAG toggle
     ***********************/
    ragToggleBtn.addEventListener('click', () => {
      ragEnabled = !ragEnabled;
      ragToggleBtn.textContent = ragEnabled ? "üß† RAG: —É–≤—ñ–º–∫–Ω–µ–Ω–æ" : "üß† RAG: –≤–∏–º–∫–Ω–µ–Ω–æ";
      ragToggleBtn.setAttribute("aria-pressed", String(ragEnabled));
      setStatus("–ì–æ—Ç–æ–≤–æ");
    });

    /***********************
     * Inputs
     ***********************/
    imageInput.addEventListener('change', async () => {
      const file = imageInput.files?.[0];
      if(!file) return;

      if(!file.type.startsWith("image/")){
        addMsg("‚ùå –¶–µ –Ω–µ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è.", "bot");
        imageInput.value = "";
        return;
      }

      const dataUrl = await fileToDataURL(file);
      pendingImageDataUrl = dataUrl;
      pendingImageLabel = file.name;

      addImagePreviewMessage({ dataUrl, caption:`–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è –¥–æ–¥–∞–Ω–æ: ${file.name}`, who:"user" });
      addMsg("–û–∫. –¢–µ–ø–µ—Ä –Ω–∞–ø–∏—à–∏, —â–æ —Å–∞–º–µ —Ç—Ä–µ–±–∞ –≤–∏–∑–Ω–∞—á–∏—Ç–∏/–ø–æ—è—Å–Ω–∏—Ç–∏ –Ω–∞ —Ü—å–æ–º—É –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—ñ.", "bot");

      imageInput.value = "";
    });

    textInput.addEventListener('change', async () => {
      const file = textInput.files?.[0];
      if(!file) return;
      const text = await file.text();

      KB.addDoc({ title: file.name, text });
      RAG.rebuildIndexFromKB();
      renderKB();

      addMsg(`‚úÖ –î–æ–¥–∞–Ω–æ/–æ–Ω–æ–≤–ª–µ–Ω–æ –º–∞—Ç–µ—Ä—ñ–∞–ª —É –±–∞–∑—ñ: ${file.name}`, "bot");
      setStatus("–ì–æ—Ç–æ–≤–æ");

      textInput.value = "";
    });

    /***********************
     * Chips & new chat
     ***********************/
    chips.addEventListener('click', (e) => {
      const chip = e.target.closest('.chip');
      if(!chip) return;
      promptEl.value = chip.textContent.replace(/\s+/g,' ').trim();
      promptEl.focus();
      autoResize();
    });

    newChatBtn.addEventListener('click', () => {
      chatLog.innerHTML = "";
      promptEl.value = "";
      autoResize();
      promptEl.focus();
      setStatus("–ì–æ—Ç–æ–≤–æ");
      closeMenu();
    });

    /***********************
     * Send (OFFLINE ONLY) ‚Äî FIX double answers
     ***********************/
    let sendingLock = false;

    sendBtn.onclick = send; // –≤–∞–∂–Ω–æ: –Ω–µ addEventListener
    promptEl.onkeydown = (e) => {
      if(e.key === "Enter" && !e.shiftKey){
        e.preventDefault();
        send();
      }
    };

    async function send(){
      const text = (promptEl.value || "").trim();
      if(!text) return;

      if (sendingLock) return;
      sendingLock = true;

      try{
        setStatus("–ü–∏—à—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å‚Ä¶");
        sendBtn.disabled = true;

        addMsg(text, "user");
        promptEl.value = "";
        autoResize();

        const contexts = ragEnabled ? RAG.retrieveTopK(text, 7) : [];
        const offline = offlineAnswerFromContexts(text, contexts);

        addMsg(offline, "bot");

        pendingImageDataUrl = null;
        pendingImageLabel = null;

        setStatus("–ì–æ—Ç–æ–≤–æ");
      }catch(err){
        addMsg("‚ùå –ü–æ–º–∏–ª–∫–∞: " + (err?.message || String(err)), "bot");
        setStatus("–ü–æ–º–∏–ª–∫–∞");
      }finally{
        sendBtn.disabled = false;
        sendingLock = false;
      }
    }

    /***********************
     * KB storage (docs) ‚Äî FIX duplicates + upsert by title
     ***********************/
    const KB = {
      key: "bioconsult_kb_docs",

      getAll(){
        try { return JSON.parse(localStorage.getItem(this.key) || "[]"); }
        catch { return []; }
      },

      setAll(docs){
        localStorage.setItem(this.key, JSON.stringify(docs || []));
      },

      upsertByTitle(title, text){
        const docs = this.getAll();
        const t = String(title || "doc.txt");
        const i = docs.findIndex(d => d.title === t);

        if (i >= 0) {
          docs[i].text = String(text || "");
          docs[i].updatedAt = Date.now();
        } else {
          docs.push({
            id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random(),
            title: t,
            text: String(text || ""),
            createdAt: Date.now(),
            updatedAt: Date.now()
          });
        }
        this.setAll(docs);
      },

      addDoc(doc){
        this.upsertByTitle(doc.title, doc.text);
      },

      remove(id){
        const docs = this.getAll().filter(d => d.id !== id);
        this.setAll(docs);
      },

      clear(){ this.setAll([]); }
    };

    function renderKB(){
      const docs = KB.getAll();
      kbCount.textContent = `${docs.length} —Ñ–∞–π–ª—ñ–≤`;
      kbList.innerHTML = "";

      if(docs.length === 0){
        const empty = document.createElement("div");
        empty.className = "sb-item";
        empty.textContent = "–î–æ–¥–∞–π .txt/.md —á–µ—Ä–µ–∑ ‚Äú+‚Äù –∞–±–æ –ø–æ–∫–ª–∞–¥–∏ —Ñ–∞–π–ª —É data/raw";
        kbList.appendChild(empty);
        return;
      }

      docs.slice().reverse().forEach(d => {
        const row = document.createElement("div");
        row.className = "sb-item";
        row.title = "–ù–∞—Ç–∏—Å–Ω–∏, —â–æ–± –≤–∏–¥–∞–ª–∏—Ç–∏";

        const dot = document.createElement("span");
        dot.className = "badge";
        dot.style.width = "10px";
        dot.style.height = "10px";
        dot.style.boxShadow = "none";
        row.appendChild(dot);

        const name = document.createElement("div");
        name.textContent = d.title;
        name.style.flex = "1";
        row.appendChild(name);

        const del = document.createElement("span");
        del.textContent = "üóëÔ∏è";
        del.style.opacity = ".75";
        row.appendChild(del);

        row.addEventListener("click", () => {
          if(!confirm(`–í–∏–¥–∞–ª–∏—Ç–∏ "${d.title}" –∑ –±–∞–∑–∏?`)) return;
          KB.remove(d.id);
          RAG.rebuildIndexFromKB();
          renderKB();
          addMsg(`‚úÖ –í–∏–¥–∞–ª–µ–Ω–æ –∑ –±–∞–∑–∏: ${d.title}`, "bot");
        });

        kbList.appendChild(row);
      });
    }

    /***********************
     * RAG in browser (TF-IDF-ish)
     ***********************/
    const RAG = (() => {
      let chunks = [];     // {title, text, id, vec}
      let stats = null;    // {df, N}

      function tokenize(text) {
        return (text || "")
          .toLowerCase()
          .replace(/[^\p{L}\p{N}\s]+/gu, " ")
          .split(/\s+/)
          .filter(Boolean);
      }

      function chunkText(text, chunkSize = 900, overlap = 120) {
        const clean = (text || "").replace(/\s+/g, " ").trim();
        if (!clean) return [];
        const out = [];
        let i = 0;
        while (i < clean.length) {
          const end = Math.min(clean.length, i + chunkSize);
          out.push(clean.slice(i, end));
          i = end - overlap;
          if (i < 0) i = 0;
          if (end === clean.length) break;
        }
        return out;
      }

      function buildVocabStats(chunks) {
        const df = Object.create(null);
        for (const ch of chunks) {
          const seen = new Set(tokenize(ch.text));
          for (const t of seen) df[t] = (df[t] || 0) + 1;
        }
        return { df, N: chunks.length };
      }

      function embed(text, stats) {
        const toks = tokenize(text);
        const tf = Object.create(null);
        for (const t of toks) tf[t] = (tf[t] || 0) + 1;

        const vec = Object.create(null);
        const { df, N } = stats || { df:{}, N:1 };
        for (const [t, f] of Object.entries(tf)) {
          const d = df[t] || 0;
          const idf = Math.log((N + 1) / (d + 1)) + 1;
          vec[t] = f * idf;
        }
        return vec;
      }

      function cosine(a, b) {
        let dot = 0, na = 0, nb = 0;
        const keys = new Set([...Object.keys(a), ...Object.keys(b)]);
        for (const k of keys) {
          const x = a[k] || 0;
          const y = b[k] || 0;
          dot += x * y;
          na += x * x;
          nb += y * y;
        }
        if (!na || !nb) return 0;
        return dot / (Math.sqrt(na) * Math.sqrt(nb));
      }

      function rebuildIndexFromKB(){
        const docs = KB.getAll();
        chunks = [];
        for (const d of docs) {
          const parts = chunkText(d.text);
          parts.forEach((p, idx) => {
            chunks.push({ title: d.title, text: p, id: `${d.title}#${idx}` });
          });
        }
        stats = buildVocabStats(chunks);
        chunks.forEach(ch => ch.vec = embed(ch.text, stats));
      }

      function retrieveTopK(question, k=6){
        if(!stats || !chunks.length) return [];
        const qvec = embed(question, stats);
        const scored = chunks.map(ch => ({ ch, score: cosine(qvec, ch.vec) }));
        scored.sort((a,b)=>b.score-a.score);

        // ‚úÖ –ü—ñ–¥–≤–∏—â–µ–Ω–∏–π –ø–æ—Ä—ñ–≥, —â–æ–± –º–µ–Ω—à–µ "–ª—ñ–≤–∏—Ö" –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π
        return scored
          .slice(0, k)
          .filter(x => x.score > 0.12)
          .map(x => x.ch);
      }

      return { rebuildIndexFromKB, retrieveTopK };
    })();

    // ===============================
    // OFFLINE Answer v3 (–±–µ–∑ API)
    // - –∑–≤‚Äô—è–∑–Ω–∏–π "—è–∫ Gemini" —Å—Ç–∏–ª—å
    // - –ù–ï –ø–æ–∫–∞–∑—É—î –∫–æ–Ω—Å–ø–µ–∫—Ç–∏ —ñ –Ω–µ —Ü–∏—Ç—É—î
    // - –º—ñ–Ω—ñ–º—ñ–∑—É—î "–Ω–µ—Å–≤—è–∑–Ω—ñ" —Ñ—Ä–∞–∑–∏
    // ===============================
    function offlineAnswerFromContexts(question, contexts) {
      const q = (question || "").trim();
      if (!q) return "–ù–∞–ø–∏—à–∏ –∑–∞–ø–∏—Ç–∞–Ω–Ω—è üôÇ";

      if (!Array.isArray(contexts) || contexts.length === 0) {
        return "–£ –±–∞–∑—ñ –∑–Ω–∞–Ω—å –Ω–µ–º–∞—î —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ–≥–æ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞ –ø—ñ–¥ —Ü–µ –ø–∏—Ç–∞–Ω–Ω—è. –°–ø—Ä–æ–±—É–π –∫–æ—Ä–æ—Ç—à–µ/—Ç–æ—á–Ω—ñ—à–µ (2‚Äì6 –∫–ª—é—á–æ–≤–∏—Ö —Å–ª—ñ–≤).";
      }

      const intent = detectIntent(q);
      const facts = extractFactsFromContexts(q, contexts);

      if (!facts.ok) {
        // —è–∫—â–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç —î, –∞–ª–µ —Å–ª–∞–±–∫–∏–π ‚Äî –¥–∞—î–º–æ –∫–æ—Ä–æ—Ç–∫—É –∫–æ—Ä–∏—Å–Ω—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å-—Ä–∞–º–∫—É –±–µ–∑ –≤–æ–¥–∏
        return buildSafeFallback(q, intent);
      }

      // –†–æ–±–∏–º–æ "—É–Ω—ñ–∫–∞–ª—å–Ω—ñ—Å—Ç—å" —á–µ—Ä–µ–∑ –ø–µ—Ä–µ—Ñ—Ä–∞–∑ + —Å—Ç—Ä—É–∫—Ç—É—Ä—É
      return composeAnswer(q, intent, facts.bullets);
    }

    function detectIntent(q) {
      const s = normalizeText(q);
      if (/(—Ä—ñ–∑–Ω–∏—Ü|–≤—ñ–¥—Ä—ñ–∑–Ω—è|vs|–ø–æ—Ä—ñ–≤–Ω—è)/i.test(s)) return "compare";
      if (/(–µ—Ç–∞–ø|—Å—Ç–∞–¥|—Ñ–∞–∑|–∫—Ä–æ–∫|–ø—Ä–æ—Ü–µ—Å|—è–∫ –≤—ñ–¥–±—É–≤–∞)/i.test(s)) return "process";
      if (/(—Ñ—É–Ω–∫—Ü|—Ä–æ–ª—å|–¥–ª—è —á–æ–≥–æ|–Ω–∞–≤—ñ—â–æ)/i.test(s)) return "function";
      if (/(—â–æ —Ç–∞–∫–µ|–≤–∏–∑–Ω–∞—á|–ø–æ—è—Å–Ω–∏|–æ–∑–Ω–∞—á–∞—î)/i.test(s)) return "define";
      return "general";
    }

    function extractFactsFromContexts(question, contexts) {
      const qTokens = keyTokens(question);

      const candidates = [];
      for (const c of contexts.slice(0, 5)) {
        const txt = String(c?.text || "");
        const sentences = splitSentences(cleanMarkup(txt));

        for (const sent of sentences) {
          const s = sent.trim();
          if (s.length < 25) continue;

          const score = scoreSentence(s, qTokens);
          if (score >= 2 && looksLikeFact(s) && !looksLikeGarbage(s)) {
            candidates.push({ s, score });
          }
        }
      }

      candidates.sort((a, b) => b.score - a.score);

      const uniq = [];
      const seen = new Set();
      for (const it of candidates) {
        const k = normalizeText(it.s).slice(0, 220);
        if (seen.has(k)) continue;
        seen.add(k);
        uniq.push(it.s);
        if (uniq.length >= 10) break;
      }

      if (uniq.length < 2) return { ok: false, bullets: [] };

      const bullets = uniq
        .map(s => compressSentence(s))
        .filter(Boolean)
        .slice(0, 8);

      return { ok: bullets.length >= 2, bullets };
    }

    function scoreSentence(sentence, qTokens) {
      const s = normalizeText(sentence);
      let score = 0;
      for (const t of qTokens) if (s.includes(t)) score += 1;
      if (/(‚Äî —Ü–µ|—Ü–µ |–Ω–∞–∑–∏–≤–∞|–æ–∑–Ω–∞—á–∞|–≤–∏–∑–Ω–∞—á–∞)/i.test(sentence)) score += 1;
      if (/(—Å–∫–ª–∞–¥–∞|–º—ñ—Å—Ç–∏—Ç—å|—Ö–∞—Ä–∞–∫—Ç–µ—Ä|–≤—ñ–¥–±—É–≤–∞|–ø–æ—Ç—Ä—ñ–±–Ω|–∑–∞–±–µ–∑–ø–µ—á|—Ñ—É–Ω–∫—Ü|—Ä–æ–ª—å)/i.test(sentence)) score += 1;
      return score;
    }

    function looksLikeFact(s) {
      if (/(—è –¥—É–º–∞—é|–º–æ–∂–ª–∏–≤–æ|–π–º–æ–≤—ñ—Ä–Ω–æ|–Ω–∞–ø–µ–≤–Ω–æ)/i.test(s)) return false;
      return /[A-Za-z–ê-–Ø–∞-—è–Ü–á–Ñ“ê—ñ—î—ó“ë]/.test(s);
    }

    function looksLikeGarbage(s){
      // –ø—Ä–∏–±–∏—Ä–∞—î–º–æ —Ç–∏–ø–æ–≤—ñ "–≤–∏–ø–∞–¥–∫–æ–≤—ñ" –≤—Å—Ç–∞–≤–∫–∏ –∑—ñ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ—é, —è–∫—â–æ –ø–∏—Ç–∞–Ω–Ω—è –Ω–µ –ø—Ä–æ –≥–µ–Ω–µ—Ç–∏–∫—É
      const t = normalizeText(s);
      if (/(9 3 3 1|1 2 1|3 1|aa|Aa|AA)/i.test(t)) return true;
      if (t.length < 15) return true;
      return false;
    }

    function composeAnswer(question, intent, bullets) {
      // –±–µ—Ä–µ–º–æ 4-6 —Ñ–∞–∫—Ç—ñ–≤ —ñ –ø–µ—Ä–µ—Ñ—Ä–∞–∑–æ–≤—É—î–º–æ
      const base = bullets.slice(0, 6).map(b => rewriteSoft(b));

      const intro = makeIntro(intent);
      const core = buildCore(intent, base);
      const extra = buildExtra(intent, base);

      return [intro, core, extra].filter(Boolean).join("\n\n");
    }

    function makeIntro(intent){
      if (intent === "compare") return "–û—Å—å —Ä—ñ–∑–Ω–∏—Ü—è –ø—Ä–æ—Å—Ç–∏–º–∏ —Å–ª–æ–≤–∞–º–∏:";
      if (intent === "process") return "–û–ø–∏—Å –ø—Ä–æ—Ü–µ—Å—É –ø–æ –∫—Ä–æ–∫–∞—Ö:";
      if (intent === "function") return "–ö–ª—é—á–æ–≤—ñ —Ñ—É–Ω–∫—Ü—ñ—ó —Ç–∞ —Ä–æ–ª—å:";
      if (intent === "define") return "–ö–æ—Ä–æ—Ç–∫–µ –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è –π —Å—É—Ç—å:";
      return "–ü–æ—è—Å–Ω–µ–Ω–Ω—è –ø—Ä–æ—Å—Ç–∏–º–∏ —Å–ª–æ–≤–∞–º–∏:";
    }

    function buildCore(intent, items){
      if (intent === "process"){
        const steps = items.slice(0,5).map((t,i)=>`${i+1}) ${t}`);
        return steps.join("\n");
      }
      if (intent === "compare"){
        const a = items.slice(0,3);
        const b = items.slice(3,6);
        const left = a.length ? ("‚Ä¢ " + a.join("\n‚Ä¢ ")) : "";
        const right = b.length ? ("‚Ä¢ " + b.join("\n‚Ä¢ ")) : "";
        return [left, right].filter(Boolean).join("\n");
      }
      // define/function/general
      return items.slice(0,4).join(" ");
    }

    function buildExtra(intent, items){
      if (intent === "compare"){
        return "–Ø–∫—â–æ —Å–∫–∞–∂–µ—à, —è–∫—ñ —Å–∞–º–µ 2 –ø–æ–Ω—è—Ç—Ç—è –ø–æ—Ä—ñ–≤–Ω—é—î–º–æ, –∑—Ä–æ–±–ª—é —Ç–∞–±–ª–∏—Ü—é ¬´A vs B¬ª.";
      }
      if (intent === "process"){
        return "–Ø–∫—â–æ —Ç—Ä–µ–±–∞ ‚Äî —É—Ç–æ—á–Ω–∏ —Ä—ñ–≤–µ–Ω—å (7/9/11 –∫–ª–∞—Å), —ñ —è –ø—ñ–¥–ª–∞—à—Ç—É—é —Å–∫–ª–∞–¥–Ω—ñ—Å—Ç—å.";
      }
      if (intent === "function"){
        return "–•–æ—á–µ—à ‚Äî –¥–æ–¥–∞–º –ø—Ä–∏–∫–ª–∞–¥–∏ (–¥–µ —Å–∞–º–µ —Ü–µ –∑—É—Å—Ç—Ä—ñ—á–∞—î—Ç—å—Å—è —ñ —è–∫ –ø–µ—Ä–µ–≤—ñ—Ä—è—é—Ç—å –Ω–∞ –ø—Ä–∞–∫—Ç–∏—Ü—ñ).";
      }
      return "";
    }

    function buildSafeFallback(q, intent){
      if (intent === "compare"){
        return "–©–æ–± —á—ñ—Ç–∫–æ –ø–æ—Ä—ñ–≤–Ω—è—Ç–∏, –Ω–∞–ø–∏—à–∏ –¥–≤–∞ —Ç–µ—Ä–º—ñ–Ω–∏ —É —Ñ–æ—Ä–º–∞—Ç—ñ: ¬´A vs B¬ª.";
      }
      if (intent === "process"){
        return "–Ø –±–∞—á—É —Ç–µ–º—É, –∞–ª–µ –≤ –±–∞–∑—ñ –º–∞–ª–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏—Ö –∫—Ä–æ–∫—ñ–≤. –ù–∞–ø–∏—à–∏: ¬´–µ—Ç–∞–ø–∏ + –Ω–∞–∑–≤–∞ –ø—Ä–æ—Ü–µ—Å—É¬ª.";
      }
      if (intent === "define"){
        return "–£—Ç–æ—á–Ω–∏ —Ç–µ—Ä–º—ñ–Ω –æ–¥–Ω–∏–º —Å–ª–æ–≤–æ–º (–∞–±–æ 2‚Äì3), —ñ —è –¥–∞–º —Ç–æ—á–Ω–µ –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è –∑ –±–∞–∑–∏.";
      }
      return "–£—Ç–æ—á–Ω–∏ –∑–∞–ø–∏—Ç 2‚Äì6 –∫–ª—é—á–æ–≤–∏–º–∏ —Å–ª–æ–≤–∞–º–∏ ‚Äî —Ç–æ–¥—ñ RAG –∑–Ω–∞–π–¥–µ —Ç–æ—á–Ω—ñ—à–∏–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç.";
    }

    function rewriteSoft(s) {
      let t = String(s || "").trim().replace(/\s+/g, " ");
      t = t.replace(/^\W+|\W+$/g, "");

      // –ª–µ–≥–∫–µ –ø–µ—Ä–µ—Ñ—Ä–∞–∑—É–≤–∞–Ω–Ω—è –±–µ–∑ –ª–∞–º–∞–Ω–Ω—è –∑–º—ñ—Å—Ç—É
      const repl = [
        [/\b—Ü–µ\b/gi, "—Ü–µ —è–≤–∏—â–µ"],
        [/\b–∑–∞–±–µ–∑–ø–µ—á—É—î\b/gi, "–¥–æ–ø–æ–º–∞–≥–∞—î –∑–∞–±–µ–∑–ø–µ—á–∏—Ç–∏"],
        [/\b–≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è\b/gi, "–ø—Ä–æ—Ö–æ–¥–∏—Ç—å"],
        [/\b–≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è\b/gi, "–∑–∞—Å—Ç–æ—Å–æ–≤—É—î—Ç—å—Å—è"],
        [/\b—Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏–∑—É—î—Ç—å—Å—è\b/gi, "–∑–∞–∑–≤–∏—á–∞–π –æ–ø–∏—Å—É—é—Ç—å —è–∫"],
      ];
      for (const [a,b] of repl) t = t.replace(a,b);

      if (t.length > 240) t = t.slice(0, 240).trim() + "‚Ä¶";
      return t;
    }

    function normalizeText(s) {
      return String(s || "")
        .toLowerCase()
        .replace(/[^\p{L}\p{N}\s]+/gu, " ")
        .replace(/\s+/g, " ")
        .trim();
    }

    function keyTokens(s) {
      const stop = new Set(["—è–∫–∏–π","—è–∫–∞","—è–∫–µ","—â–æ","—Ç–∞–∫–µ","—Ü–µ","–ø—Ä–æ","–¥–ª—è","–∫–æ–ª–∏","—è–∫","—Ç–∞","–∞–±–æ","—á–∏","—É","–≤","–Ω–∞","–¥–æ","–∑","—ñ–∑","–º–∏","–≤–∏","–≤–æ–Ω–∏","–¥–µ","—î","—á–∏"]);
      return normalizeText(s)
        .split(" ")
        .filter(w => w.length >= 4 && !stop.has(w))
        .slice(0, 12);
    }

    function cleanMarkup(s) {
      return String(s || "")
        .replace(/[*_`#>-]+/g, " ")
        .replace(/\s+/g, " ")
        .trim();
    }

    function splitSentences(text) {
      const t = String(text || "").trim();
      if (!t) return [];
      return t.split(/(?<=[.!?‚Ä¶])\s+/);
    }

    function compressSentence(s) {
      let t = String(s || "").replace(/\([^)]*\)/g, "").trim();
      t = t.replace(/\s+/g, " ");
      if (t.length < 25) return "";
      if (t.length > 280) t = t.slice(0, 280).trim() + "‚Ä¶";
      return t;
    }

    /***********************
     * Seed KB from repo ‚Äî ALWAYS refresh from file
     * app/index.html -> ../data/raw/biology_basics.txt
     ***********************/
    async function seedKBFromRepoAlways() {
      const url = "../data/raw/biology_basics.txt";
      try {
        setStatus("–û–Ω–æ–≤–ª—é—é –±–∞–∑—É –∑–Ω–∞–Ω—å‚Ä¶");
        const res = await fetch(url, { cache: "no-store" });
        if (!res.ok) throw new Error("–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ " + url + " (HTTP " + res.status + ")");
        const text = await res.text();

        KB.upsertByTitle("biology_basics.txt", text);
        RAG.rebuildIndexFromKB();
        renderKB();

        setStatus("–ì–æ—Ç–æ–≤–æ");
      } catch (e) {
        addMsg(
          "‚ö†Ô∏è –ù–µ –∑–º—ñ–≥ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –±–∞–∑—É –∑–Ω–∞–Ω—å –∑ —Ä–µ–ø–æ.\n" +
          "–ü–µ—Ä–µ–≤—ñ—Ä —à–ª—è—Ö: data/raw/biology_basics.txt\n" +
          "–ü–æ–º–∏–ª–∫–∞: " + (e?.message || String(e)),
          "bot"
        );
        setStatus("–ì–æ—Ç–æ–≤–æ");
      }
    }

    /***********************
     * Helpers
     ***********************/
    function fileToDataURL(file){
      return new Promise((resolve, reject) => {
        const r = new FileReader();
        r.onload = () => resolve(r.result);
        r.onerror = reject;
        r.readAsDataURL(file);
      });
    }

    /***********************
     * Init
     ***********************/
    async function init(){
      renderKB();
      RAG.rebuildIndexFromKB();
      autoResize();
      setStatus("–ì–æ—Ç–æ–≤–æ");

      // ‚úÖ –∑–∞–≤–∂–¥–∏ –ø—ñ–¥—Ç—è–≥—É—î–º–æ —Ñ–∞–π–ª –∑ —Ä–µ–ø–æ —ñ –ù–ï –¥—É–±–ª—é—î–º–æ
      await seedKBFromRepoAlways();

      // –ø—ñ–¥–∫–∞–∑–∫–∞ –ø—Ä–∏ –ø–µ—Ä—à–æ–º—É –∑–∞–ø—É—Å–∫—É
      if (KB.getAll().length === 0) {
        addMsg("–î–æ–¥–∞–π –º–∞—Ç–µ—Ä—ñ–∞–ª —á–µ—Ä–µ–∑ ‚Äú+‚Äù –∞–±–æ –ø–æ–∫–ª–∞–¥–∏ —Ñ–∞–π–ª —É data/raw/biology_basics.txt.", "bot");
      }
    }
    init();
  </script>
</body>
</html>
