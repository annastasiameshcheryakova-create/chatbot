<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BioConsult ‚Äî —á–∞—Ç-–±–æ—Ç –∑ –±—ñ–æ–ª–æ–≥—ñ—ó</title>

  <style>
    :root{
      --bg:#f6fbf8;
      --panel:#ffffffcc;
      --muted:#7a8f86;
      --text:#24332d;
      --line:#e4efe9;

      --accent:#9fc9b4;
      --accent-soft:#edf6f2;
      --accent-strong:#86b8a1;

      --shadow: 0 12px 30px rgba(0,0,0,.06);
      --r:18px;
      --rLg:26px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background:
        radial-gradient(900px 500px at 80% 0%, #eaf4ef, transparent 60%),
        radial-gradient(700px 450px at 10% 10%, #f2f8f5, transparent 55%),
        var(--bg);
    }

    .app{ height:100dvh; display:grid; grid-template-columns: 320px 1fr; }

    /* Sidebar */
    .sidebar{
      background:rgba(255,255,255,.65);
      backdrop-filter: blur(14px);
      border-right:1px solid var(--line);
      padding:14px 12px;
      display:flex;
      flex-direction:column;
      min-width:280px;
    }
    .sb-top{ display:flex; align-items:center; justify-content:space-between; padding:6px 6px 10px; }
    .brand{ display:flex;align-items:center;gap:10px; font-weight:780; letter-spacing:-.2px; }
    .logo{
      width:30px;height:30px;border-radius:10px;
      background: linear-gradient(135deg, #cfe6dc, #b6d8c9);
      box-shadow:0 6px 14px rgba(134,184,161,.35);
    }
    .iconbtn{
      width:38px;height:38px;border-radius:999px;
      border:1px solid transparent;
      background:transparent;
      cursor:pointer;
      display:grid;place-items:center;
      color:#203127;
    }
    .iconbtn:hover{ background:rgba(0,0,0,.05); }

    .newchat{
      margin:6px;
      display:flex;align-items:center;gap:10px;
      padding:10px 12px;
      border-radius:999px;
      background:var(--panel);
      border:1px solid var(--line);
      cursor:pointer;
      box-shadow:0 1px 0 rgba(0,0,0,.03);
    }
    .badge{
      width:12px;height:12px;border-radius:50%;
      background:var(--accent-strong);
      box-shadow:0 0 0 6px rgba(159,201,180,.25);
    }
    .sb-section{
      margin:10px 6px 6px;
      font-size:13px;
      color:var(--muted);
      display:flex;align-items:center;justify-content:space-between;
      padding:6px 4px;
    }
    .sb-list{ padding:6px; overflow:auto; flex:1; }
    .sb-item{
      padding:10px 10px;
      border-radius:14px;
      font-size:14px;
      color:#233528;
      cursor:pointer;
      display:flex;align-items:center;gap:10px;
    }
    .sb-item:hover{ background:var(--accent-soft); }
    .sb-footer{
      border-top:1px solid var(--line);
      padding:10px 6px 6px;
      font-size:13px;
      color:var(--muted);
      display:flex;align-items:center;gap:8px;
    }

    /* Main */
    .main{ position:relative; display:flex; flex-direction:column; min-width:0; }
    .topbar{
      height:64px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:12px 18px;
      gap:12px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.75);
      backdrop-filter: blur(10px);
      box-shadow:0 1px 0 rgba(0,0,0,.02);
      font-size:13px;
      color:#40574e;
      white-space:nowrap;
      user-select:none;
    }
    .avatar{
      width:36px;height:36px;border-radius:999px;
      background:linear-gradient(135deg,#f1faf6,#ffffff);
      border:1px solid var(--line);
    }

    .content{
      flex:1;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      padding:10px 18px 170px;
      min-height:0;
    }

    .hero{ width:min(900px, 100%); padding:10px 8px 16px; }
    .hello{
      font-size:18px;
      font-weight:650;
      display:flex;
      align-items:center;
      gap:10px;
      color:#1f2f26;
      margin-bottom:8px;
    }
    .leafMark{
      width:22px;height:22px;
      background: linear-gradient(135deg, #cfe6dc, #9fc9b4);
      border-radius:7px;
      transform: rotate(10deg);
    }
    .title{
      font-size:40px;
      font-weight:820;
      letter-spacing:-.6px;
      line-height:1.12;
      margin:0;
      color:#1f2e28;
    }
    .subtitle{
      margin-top:10px;
      max-width:78ch;
      color:var(--muted);
      font-size:15px;
      line-height:1.45;
    }

    /* Chat */
    .chatlog{
      width:min(900px, 100%);
      margin-top:14px;
      display:flex;
      flex-direction:column;
      gap:10px;
      max-height:48vh;
      overflow:auto;
      padding:0 8px 8px;
    }
    .msg{
      max-width:78ch;
      padding:12px 14px;
      border-radius:16px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.75);
      backdrop-filter: blur(10px);
      box-shadow:0 1px 0 rgba(0,0,0,.02);
      white-space:pre-wrap;
      line-height:1.35;
      font-size:15px;
    }
    .msg.user{
      align-self:flex-end;
      background:#eef7f3;
      border-color:#d6ebe2;
    }
    .msg.bot{ align-self:flex-start; }

    /* Composer */
    .composer-wrap{
      position:absolute;
      left:0; right:0; bottom:0;
      padding:18px;
      display:flex;
      justify-content:center;
      background:linear-gradient(to top, rgba(246,251,248,1), rgba(246,251,248,.7), rgba(246,251,248,0));
      pointer-events:none;
    }
    .composer-area{ width:min(920px, 100%); pointer-events:auto; }

    .composer{
      border-radius: var(--rLg);
      border:1px solid #dcebe4;
      background:rgba(255,255,255,.82);
      backdrop-filter: blur(14px);
      box-shadow: var(--shadow);
      padding:10px;
      position:relative;
    }

    .composer-row{ display:flex; align-items:center; gap:10px; }

    .plus{
      width:38px;height:38px;border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      cursor:pointer;
      display:grid;place-items:center;
      color:#3b4d46;
      position:relative;
    }
    .plus:hover{ background:var(--accent-soft); border-color:#cfe6dc; }

    .input{
      flex:1;
      display:flex;
      align-items:center;
      gap:10px;
      padding:8px 10px;
      border-radius:999px;
      background:#ffffff;
      border:1px solid #dcebe4;
      min-width:0;
    }
    .input textarea{
      width:100%;
      border:0;
      outline:none;
      resize:none;
      background:transparent;
      font-size:15px;
      line-height:1.35;
      height:24px;
      max-height:120px;
      color:var(--text);
    }

    .tools{ display:flex; align-items:center; gap:8px; flex:0 0 auto; }

    .send{
      width:40px;height:40px;border-radius:999px;
      border:1px solid #9fc9b4;
      background: linear-gradient(180deg, #b8dccc, #9fc9b4);
      color:white;
      cursor:pointer;
      display:grid;place-items:center;
      box-shadow:0 8px 18px rgba(159,201,180,.35);
    }
    .send:hover{ filter:brightness(1.03); }

    .chips{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      padding:12px 8px 0;
    }
    .chip{
      background:var(--accent-soft);
      border:1px solid #cfe6dc;
      border-radius:999px;
      padding:10px 14px;
      font-size:14px;
      color:#355349;
      cursor:pointer;
      user-select:none;
    }
    .chip:hover{ background:#e3f1ea; }

    .hint{
      width:min(920px, 100%);
      padding:6px 8px 0;
      color:var(--muted);
      font-size:12px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }

    /* Plus menu */
    .plusMenu{
      position:absolute;
      left:12px;
      bottom:92px;
      width:340px;
      border-radius:16px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.92);
      backdrop-filter: blur(14px);
      box-shadow: var(--shadow);
      padding:10px;
      display:none;
      z-index:50;
    }
    .plusMenu.open{ display:block; }

    .pmTitle{
      font-size:12px;
      color:var(--muted);
      padding:6px 8px 10px;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .pmGrid{ display:grid; grid-template-columns: 1fr; gap:8px; }

    .pmBtn{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:#fff;
      cursor:pointer;
      text-align:left;
    }
    .pmBtn:hover{ background:var(--accent-soft); border-color:#cfe6dc; }
    .pmBtn .l{ display:flex; align-items:center; gap:10px; color:#2f463d; font-size:14px; font-weight:600; }
    .pmBtn .r{ color:var(--muted); font-size:12px; }

    .tiny{
      font-size:12px;
      color:var(--muted);
      padding: 0 6px 10px;
      line-height: 1.35;
    }

    @media (max-width: 920px){
      .app{ grid-template-columns: 1fr; }
      .sidebar{ display:none; }
      .title{ font-size:34px; }
      .plusMenu{ left:18px; right:18px; width:auto; }
    }
  </style>
</head>

<body>
  <div class="app">
    <aside class="sidebar">
      <div class="sb-top">
        <button class="iconbtn" title="–ú–µ–Ω—é" aria-label="–ú–µ–Ω—é">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
            <path d="M4 6h16M4 12h16M4 18h16"/>
          </svg>
        </button>

        <div class="brand">
          <span class="logo" aria-hidden="true"></span>
          <span>BioConsult</span>
        </div>

        <button class="iconbtn" title="–ü–æ—à—É–∫" aria-label="–ü–æ—à—É–∫">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
            <circle cx="11" cy="11" r="7"></circle>
            <path d="M20 20l-3.2-3.2"></path>
          </svg>
        </button>
      </div>

      <button class="newchat" id="newChatBtn">
        <span class="badge"></span>
        <span>–ù–æ–≤–∏–π –¥—ñ–∞–ª–æ–≥</span>
      </button>

      <div class="sb-section"><span>–ë–∞–∑–∞ –∑–Ω–∞–Ω—å</span><span style="opacity:.7" id="kbCount">0 —Ñ–∞–π–ª—ñ–≤</span></div>
      <div class="sb-list" id="kbList"></div>

      <div class="sb-footer">üß¨ BioConsult ‚Ä¢ biology_basics.txt</div>
    </aside>

    <main class="main" id="main">
      <header class="topbar">
        <div class="pill" style="cursor:default">üß¨ BioConsult</div>
        <div style="display:flex; align-items:center; gap:10px;">
          <button class="pill" id="ragToggleBtn" aria-pressed="true" style="cursor:pointer">üîé –ü–æ—à—É–∫: —É–≤—ñ–º–∫–Ω–µ–Ω–æ</button>

          <!-- ‚úÖ –î–û–î–ê–ù–û: LLM toggle (–Ω—ñ—á–æ–≥–æ –Ω–µ –ø—Ä–∏–±–∏—Ä–∞—î) -->
          <button class="pill" id="llmToggleBtn" aria-pressed="false" style="cursor:pointer">‚ú® LLM: –≤–∏–º–∫–Ω–µ–Ω–æ</button>

          <div class="avatar" title="–ü—Ä–æ—Ñ—ñ–ª—å"></div>
        </div>
      </header>

      <section class="content">
        <div class="hero">
          <div class="hello">
            <span class="leafMark" aria-hidden="true"></span>
            <span>–ü—Ä–∏–≤—ñ—Ç! –Ø BioConsult</span>
          </div>

          <h1 class="title">–¢–≤—ñ–π —á–∞—Ç-–±–æ—Ç –∑ –±—ñ–æ–ª–æ–≥—ñ—ó</h1>

          <div class="subtitle">
            –í—ñ–¥–ø–æ–≤—ñ–¥–∞—é <b>—Ç—ñ–ª—å–∫–∏</b> —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞–º–∏ –∑ <b>biology_basics.txt</b> –∑–∞ –∫–ª—é—á–æ–≤–∏–º–∏ —Å–ª–æ–≤–∞–º–∏.
            –ü—ñ–¥—Ç—Ä–∏–º—É—é **–∂–∏—Ä–Ω–∏–π** —á–µ—Ä–µ–∑ –∑—ñ—Ä–æ—á–∫–∏: <b>**—Ç–∞–∫**</b>.
          </div>
        </div>

        <div class="chatlog" id="chatLog" aria-live="polite"></div>
      </section>

      <div class="composer-wrap">
        <div class="composer-area">
          <div class="composer" id="composer">
            <div class="plusMenu" id="plusMenu" role="menu" aria-label="–ú–µ–Ω—é –¥–æ–¥–∞–≤–∞–Ω–Ω—è">
              <div class="pmTitle">
                <span>–î–æ–¥–∞—Ç–∏</span>
                <button class="iconbtn" id="closePlusMenu" title="–ó–∞–∫—Ä–∏—Ç–∏" aria-label="–ó–∞–∫—Ä–∏—Ç–∏" style="width:32px;height:32px;">‚úï</button>
              </div>
              <div class="pmGrid">
                <button class="pmBtn" id="pmAddTextFile" type="button">
                  <div class="l">üìÑ –î–æ–¥–∞—Ç–∏ –º–∞—Ç–µ—Ä—ñ–∞–ª (.txt/.md)</div>
                  <div class="r">–ª–æ–∫–∞–ª—å–Ω–æ</div>
                </button>
                <button class="pmBtn" id="pmClearKB" type="button">
                  <div class="l">üßΩ –û—á–∏—Å—Ç–∏—Ç–∏ –±–∞–∑—É</div>
                  <div class="r">–ª–æ–∫–∞–ª—å–Ω–æ</div>
                </button>
                <button class="pmBtn" id="pmClearChat" type="button">
                  <div class="l">üßπ –û—á–∏—Å—Ç–∏—Ç–∏ —á–∞—Ç</div>
                  <div class="r">—Å–∫–∏–Ω—É—Ç–∏</div>
                </button>
              </div>
              <div class="tiny">–í—ñ–¥–ø–æ–≤—ñ–¥—ñ –±–µ—Ä—É—Ç—å—Å—è —Ç—ñ–ª—å–∫–∏ –∑ <b>biology_basics.txt</b>.</div>
            </div>

            <div class="composer-row">
              <button class="plus" id="plusBtn" title="–î–æ–¥–∞—Ç–∏" aria-label="–î–æ–¥–∞—Ç–∏">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                  <path d="M12 5v14M5 12h14"/>
                </svg>
              </button>

              <div class="input">
                <textarea id="prompt" placeholder="–ó–∞–ø–∏—Ç–∞–π—Ç–µ BioConsult‚Ä¶" rows="1"></textarea>
              </div>

              <div class="tools">
                <button class="send" id="sendBtn" title="–ù–∞–¥—ñ—Å–ª–∞—Ç–∏" aria-label="–ù–∞–¥—ñ—Å–ª–∞—Ç–∏">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M5 12h14"></path>
                    <path d="M13 5l7 7-7 7"></path>
                  </svg>
                </button>
              </div>
            </div>

            <div class="chips" id="chips">
              <div class="chip">üåø –©–æ —Ç–∞–∫–µ —Ñ–æ—Ç–æ—Å–∏–Ω—Ç–µ–∑?</div>
              <div class="chip">üß¨ –©–æ —Ç–∞–∫–µ –î–ù–ö?</div>
              <div class="chip">üß´ –©–æ —Ç–∞–∫–µ –∫–ª—ñ—Ç–∏–Ω–∞?</div>
              <div class="chip">‚ö° –©–æ —Ç–∞–∫–µ –ê–¢–§?</div>
            </div>

            <div class="hint">
              <span>Enter ‚Äî –Ω–∞–¥—ñ—Å–ª–∞—Ç–∏ ‚Ä¢ Shift+Enter ‚Äî –Ω–æ–≤–∏–π —Ä—è–¥–æ–∫ ‚Ä¢ ‚Äú+‚Äù ‚Äî –¥–æ–¥–∞—Ç–∏ —Ñ–∞–π–ª</span>
              <span id="statusText">–ì–æ—Ç–æ–≤–æ</span>
            </div>

            <input id="textInput" type="file" accept=".txt,.md,text/plain,text/markdown" hidden />
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    const promptEl = document.getElementById('prompt');
    const chatLog  = document.getElementById('chatLog');
    const chips    = document.getElementById('chips');
    const newChatBtn = document.getElementById('newChatBtn');
    const statusText = document.getElementById('statusText');

    const ragToggleBtn = document.getElementById('ragToggleBtn');

    // ‚úÖ –î–û–î–ê–ù–û
    const llmToggleBtn = document.getElementById('llmToggleBtn');

    const plusBtn = document.getElementById('plusBtn');
    const plusMenu = document.getElementById('plusMenu');
    const closePlusMenu = document.getElementById('closePlusMenu');

    const pmAddTextFile  = document.getElementById('pmAddTextFile');
    const pmClearChat    = document.getElementById('pmClearChat');
    const pmClearKB      = document.getElementById('pmClearKB');

    const textInput  = document.getElementById('textInput');

    const kbList = document.getElementById('kbList');
    const kbCount = document.getElementById('kbCount');

    let sendBtn = document.getElementById('sendBtn');
    let ragEnabled = true;

    // ‚úÖ –î–û–î–ê–ù–û
    let llmEnabled = false;

    // üî¥ –ó–ê–ú–Ü–ù–ò –Ω–∞ —Å–≤—ñ–π Cloudflare Worker URL
    const LLM_ENDPOINT = "https://YOUR-WORKER.workers.dev";

    function setStatus(t){ statusText.textContent = t; }

    function autoResize() {
      promptEl.style.height = "24px";
      promptEl.style.height = Math.min(promptEl.scrollHeight, 120) + "px";
    }
    promptEl.addEventListener('input', autoResize);

    function escapeHTML(s){
      return String(s || "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function mdLiteToHtml(s){
      let t = escapeHTML(s);
      t = t.replace(/\*\*(.+?)\*\*/g, "<b>$1</b>");
      t = t.replace(/\n/g, "<br>");
      return t;
    }

    function addMsg(text, who="user") {
      const div = document.createElement('div');
      div.className = `msg ${who}`;
      div.innerHTML = mdLiteToHtml(text);
      chatLog.appendChild(div);
      chatLog.scrollTop = chatLog.scrollHeight;
    }

    function openMenu(){ plusMenu.classList.add("open"); }
    function closeMenu(){ plusMenu.classList.remove("open"); }

    plusBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      plusMenu.classList.contains("open") ? closeMenu() : openMenu();
    });
    closePlusMenu.addEventListener('click', closeMenu);

    document.addEventListener('click', (e) => {
      if (!plusMenu.contains(e.target) && e.target !== plusBtn) closeMenu();
    });

    pmAddTextFile.addEventListener('click', () => { closeMenu(); textInput.click(); });

    pmClearChat.addEventListener('click', () => {
      closeMenu();
      chatLog.innerHTML = "";
      addMsg("–ß–∞—Ç –æ—á–∏—â–µ–Ω–æ ‚úÖ", "bot");
      setStatus("–ì–æ—Ç–æ–≤–æ");
    });

    pmClearKB.addEventListener('click', () => {
      closeMenu();
      if (!confirm("–û—á–∏—Å—Ç–∏—Ç–∏ –±–∞–∑—É –∑–Ω–∞–Ω—å (–ª–æ–∫–∞–ª—å–Ω–æ)?")) return;
      KB.clear();
      KBIndex.rebuildFromKB();
      renderKB();
      addMsg("–ë–∞–∑—É –∑–Ω–∞–Ω—å –æ—á–∏—â–µ–Ω–æ ‚úÖ", "bot");
      setStatus("–ì–æ—Ç–æ–≤–æ");
    });

    ragToggleBtn.addEventListener('click', () => {
      ragEnabled = !ragEnabled;
      ragToggleBtn.textContent = ragEnabled ? "üîé –ü–æ—à—É–∫: —É–≤—ñ–º–∫–Ω–µ–Ω–æ" : "üîé –ü–æ—à—É–∫: –≤–∏–º–∫–Ω–µ–Ω–æ";
      ragToggleBtn.setAttribute("aria-pressed", String(ragEnabled));
      setStatus("–ì–æ—Ç–æ–≤–æ");
    });

    // ‚úÖ –î–û–î–ê–ù–û: –ø–µ—Ä–µ–º–∏–∫–∞—á LLM
    llmToggleBtn.addEventListener('click', () => {
      llmEnabled = !llmEnabled;
      llmToggleBtn.textContent = llmEnabled ? "‚ú® LLM: —É–≤—ñ–º–∫–Ω–µ–Ω–æ" : "‚ú® LLM: –≤–∏–º–∫–Ω–µ–Ω–æ";
      llmToggleBtn.setAttribute("aria-pressed", String(llmEnabled));
      setStatus("–ì–æ—Ç–æ–≤–æ");
    });

    textInput.addEventListener('change', async () => {
      const file = textInput.files?.[0];
      if(!file) return;
      const text = await file.text();

      KB.addDoc({ title: file.name, text });
      KBIndex.rebuildFromKB();
      renderKB();

      addMsg(`‚úÖ –î–æ–¥–∞–Ω–æ/–æ–Ω–æ–≤–ª–µ–Ω–æ –º–∞—Ç–µ—Ä—ñ–∞–ª —É –±–∞–∑—ñ: ${file.name}`, "bot");
      setStatus("–ì–æ—Ç–æ–≤–æ");

      textInput.value = "";
    });

    chips.addEventListener('click', (e) => {
      const chip = e.target.closest('.chip');
      if(!chip) return;
      promptEl.value = chip.textContent.replace(/\s+/g,' ').trim();
      promptEl.focus();
      autoResize();
    });

    newChatBtn.addEventListener('click', () => {
      chatLog.innerHTML = "";
      promptEl.value = "";
      autoResize();
      promptEl.focus();
      setStatus("–ì–æ—Ç–æ–≤–æ");
      closeMenu();
    });

    // -------------------------
    // KB storage
    // -------------------------
    const KB = {
      key: "bioconsult_kb_docs",

      getAll(){
        try { return JSON.parse(localStorage.getItem(this.key) || "[]"); }
        catch { return []; }
      },

      setAll(docs){
        localStorage.setItem(this.key, JSON.stringify(docs || []));
      },

      upsertByTitle(title, text){
        const docs = this.getAll();
        const t = String(title || "doc.txt");
        const i = docs.findIndex(d => d.title === t);

        if (i >= 0) {
          docs[i].text = String(text || "");
          docs[i].updatedAt = Date.now();
        } else {
          docs.push({
            id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random(),
            title: t,
            text: String(text || ""),
            createdAt: Date.now(),
            updatedAt: Date.now()
          });
        }
        this.setAll(docs);
      },

      addDoc(doc){
        this.upsertByTitle(doc.title, doc.text);
      },

      remove(id){
        const docs = this.getAll().filter(d => d.id !== id);
        this.setAll(docs);
      },

      clear(){ this.setAll([]); }
    };

    function renderKB(){
      const docs = KB.getAll();
      kbCount.textContent = `${docs.length} —Ñ–∞–π–ª—ñ–≤`;
      kbList.innerHTML = "";

      if(docs.length === 0){
        const empty = document.createElement("div");
        empty.className = "sb-item";
        empty.textContent = "–ë–∞–∑–∞ –ø–æ—Ä–æ–∂–Ω—è. –î–æ–¥–∞–π —Ñ–∞–π–ª —á–µ—Ä–µ–∑ ‚Äú+‚Äù.";
        kbList.appendChild(empty);
        return;
      }

      docs.slice().reverse().forEach(d => {
        const row = document.createElement("div");
        row.className = "sb-item";
        row.title = "–ù–∞—Ç–∏—Å–Ω–∏, —â–æ–± –≤–∏–¥–∞–ª–∏—Ç–∏";

        const dot = document.createElement("span");
        dot.className = "badge";
        dot.style.width = "10px";
        dot.style.height = "10px";
        dot.style.boxShadow = "none";
        row.appendChild(dot);

        const name = document.createElement("div");
        name.textContent = d.title;
        name.style.flex = "1";
        row.appendChild(name);

        const del = document.createElement("span");
        del.textContent = "üóëÔ∏è";
        del.style.opacity = ".75";
        row.appendChild(del);

        row.addEventListener("click", () => {
          if(!confirm(`–í–∏–¥–∞–ª–∏—Ç–∏ "${d.title}" –∑ –±–∞–∑–∏?`)) return;
          KB.remove(d.id);
          KBIndex.rebuildFromKB();
          renderKB();
          addMsg(`‚úÖ –í–∏–¥–∞–ª–µ–Ω–æ –∑ –±–∞–∑–∏: ${d.title}`, "bot");
        });

        kbList.appendChild(row);
      });
    }

    // -------------------------
    // SMART ANSWER INDEX (groups)
    // -------------------------
    const UA_STOP = new Set([
      "—â–æ","—Ü–µ","—Ç–∞","—ñ","–π","–∞–±–æ","–∞–ª–µ","–≤","—É","–Ω–∞","–¥–æ","–≤—ñ–¥","–¥–ª—è","–ø—Ä–æ","—è–∫",
      "—è–∫—ñ","—è–∫–∞","—è–∫–µ","—è–∫—ñ–π","—è–∫–æ–≥–æ","—è–∫–æ—é","—è–∫–∏–º","—è–∫–∏–º–∏","—á–∏","–Ω–µ","—Ç–∞–∫","—î",
      "–∑","—ñ–∑","–∑–∞","–Ω–∞–¥","–ø—ñ–¥","–ø—Ä–∏","–º—ñ–∂","–æ","–æ–±","–ø–æ","–∫–æ–ª–∏","–¥–µ","—Ö—Ç–æ","—Ç–∏","–≤–∏",
      "–º–µ–Ω—ñ","—Ç–æ–±—ñ","–π–æ–º—É","—ó–π","—ó–º","–Ω–∞—Å","–≤–∞–º","—ó—Ö","—Ç—É—Ç","—Ç–∞–º","—Ü–µ–π","—Ü—è","—Ü–µ","—Ü—ñ"
    ]);

    function normalize(s){
      return String(s || "")
        .toLowerCase()
        .replace(/[‚Äô'`]/g, "'")
        .replace(/[^\p{L}\p{N}\s]+/gu, " ")
        .replace(/\s+/g, " ")
        .trim();
    }

    function tokensOf(s){
      const t = normalize(s);
      if(!t) return [];
      return t.split(" ")
        .map(w => w.trim())
        .filter(w => w.length >= 3 && !UA_STOP.has(w));
    }

    function parseGroupsFromText(txt){
      const lines = String(txt || "").split(/\r?\n/);
      const groups = [];
      let cur = null;
      let mode = "none"; // none | keys | ans
      for (const raw of lines){
        const line = raw.trimEnd();

        const mG = line.match(/^–ì–†–£–ü–ê –ó–ê–ü–ò–¢–£:\s*(.+)\s*$/i);
        if (mG){
          if (cur) groups.push(cur);
          cur = { title: mG[1].trim(), keysLine: "", keys: [], answer: "" };
          mode = "none";
          continue;
        }
        if (!cur) continue;

        const mK = line.match(/^–ö–ª—é—á–æ–≤—ñ —Å–ª–æ–≤–∞:\s*(.+)\s*$/i);
        if (mK){
          cur.keysLine = mK[1].trim();
          cur.keys = cur.keysLine.split(",")
            .map(x => normalize(x))
            .map(x => x.trim())
            .filter(Boolean);
          mode = "keys";
          continue;
        }
        const mA = line.match(/^–í—ñ–¥–ø–æ–≤—ñ–¥—å:\s*$/i);
        if (mA){
          mode = "ans";
          continue;
        }

        if (mode === "ans"){
          cur.answer += (cur.answer ? "\n" : "") + raw;
        }
      }
      if (cur) groups.push(cur);

      for (const g of groups){
        g.answer = String(g.answer || "").replace(/\s+$/g, "");
        g.titleNorm = normalize(g.title);
        g.keysNorm = g.keys.map(k => normalize(k));
        g.answerNorm = normalize(g.answer);
        g.keyTokenSet = new Set();
        for (const k of g.keysNorm){
          for (const tok of tokensOf(k)) g.keyTokenSet.add(tok);
        }
      }
      return groups;
    }

    function pickBestGroup(question, groups){
      const qNorm = normalize(question);
      const qToks = tokensOf(question);
      if (!qToks.length) return null;

      let best = null;

      for (const g of groups){
        let phraseHits = 0;
        for (const phrase of g.keysNorm){
          if (!phrase) continue;
          if (phrase.length < 3) continue;
          if (qNorm.includes(phrase)) phraseHits += 3;
        }

        let tokHits = 0;
        for (const t of qToks){
          if (g.keyTokenSet.has(t)) tokHits += 1;
        }

        let titleBonus = 0;
        for (const t of qToks){
          if (g.titleNorm.includes(t)) titleBonus += 0.5;
        }

        const score = phraseHits + tokHits + titleBonus;
        if (score < 2) continue;

        if (!best || score > best.score){
          best = { group: g, score };
        }
      }

      return best?.group || null;
    }

    function smartTrimAnswerForShortQuery(question, answer){
      const qToks = tokensOf(question);
      const q = normalize(question);

      const looksLikeSingleTerm =
        qToks.length <= 2 &&
        q.length <= 22 &&
        !q.includes("?");

      if (!looksLikeSingleTerm) return answer;

      const lines = String(answer || "").split(/\r?\n/).map(x => x.trim()).filter(Boolean);
      if (!lines.length) return answer;

      const joined = lines.join(" ");
      const sentences = joined.split(/(?<=[.!?‚Ä¶])\s+/).filter(Boolean);

      if (sentences.length >= 2) return sentences.slice(0, 2).join(" ");
      if (sentences.length === 1) return sentences[0];

      return lines.slice(0, 2).join("\n");
    }

    // ‚úÖ –î–û–î–ê–ù–û: –ø—Ä–∏–±–∏—Ä–∞—î "=====" —É –≤—ñ–¥–ø–æ–≤—ñ–¥—è—Ö
    function stripNoiseLines(text){
      return String(text || "")
        .split(/\r?\n/)
        .filter(l => !/^\s*[=]{3,}\s*$/.test(l))
        .join("\n")
        .trim();
    }

    // ‚úÖ –î–û–î–ê–ù–û: –≤–∏–∫–ª–∏–∫ LLM
    async function callLLM({ question, context, shortMode }) {
      const res = await fetch(LLM_ENDPOINT, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ question, context, shortMode })
      });

      if (!res.ok) throw new Error("LLM error");

      const data = await res.json();
      return String(data?.answer || "").trim();
    }

    // -------------------------
    // KBIndex: builds group index from biology_basics.txt
    // -------------------------
    const KBIndex = (() => {
      let groups = [];
      let ready = false;
      let lastSourceTitle = null;

      function rebuildFromKB(){
        const docs = KB.getAll();
        const bio = docs.find(d => d.title === "biology_basics.txt");
        if (!bio){
          groups = [];
          ready = false;
          lastSourceTitle = null;
          return;
        }
        groups = parseGroupsFromText(bio.text);
        ready = groups.length > 0;
        lastSourceTitle = bio.title;
      }

      function answer(question){
        if (!ready || !groups.length){
          return "‚ö†Ô∏è –£ –±–∞–∑—ñ –Ω–µ–º–∞—î —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–≤–∞–Ω–∏—Ö –±–ª–æ–∫—ñ–≤. –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Å—è, —â–æ —É **biology_basics.txt** —î —Ñ–æ—Ä–º–∞—Ç:\n–ì–†–£–ü–ê –ó–ê–ü–ò–¢–£ / –ö–ª—é—á–æ–≤—ñ —Å–ª–æ–≤–∞ / –í—ñ–¥–ø–æ–≤—ñ–¥—å.";
        }

        const g = pickBestGroup(question, groups);
        if (!g){
          return "–£ **biology_basics.txt** –Ω–µ –∑–Ω–∞–π—à–æ–≤ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—ó **–≥—Ä—É–ø–∏ –∑–∞–ø–∏—Ç—É**. –°–ø—Ä–æ–±—É–π —ñ–Ω—à—ñ –∫–ª—é—á–æ–≤—ñ —Å–ª–æ–≤–∞ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: ¬´—â–æ —Ç–∞–∫–µ ‚Ä¶¬ª, ¬´–≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è ‚Ä¶¬ª, ¬´–µ—Ç–∞–ø–∏ ‚Ä¶¬ª).";
        }

        const raw = String(g.answer || "").trim();
        const trimmed = smartTrimAnswerForShortQuery(question, raw);
        return trimmed || "‚ö†Ô∏è –ó–Ω–∞–π—à–æ–≤ –≥—Ä—É–ø—É, –∞–ª–µ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –ø–æ—Ä–æ–∂–Ω—è.";
      }

      return { rebuildFromKB, answer };
    })();

    // -------------------------
    // UI send
    // -------------------------
    let sendingLock = false;

    function attachSendHandlersOnce(){
      const newSendBtn = sendBtn.cloneNode(true);
      sendBtn.parentNode.replaceChild(newSendBtn, sendBtn);
      sendBtn = newSendBtn;

      sendBtn.onclick = send;

      promptEl.onkeydown = (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          send();
        }
      };
    }

    async function send(){
      const text = (promptEl.value || "").trim();
      if(!text) return;

      if (sendingLock) return;
      sendingLock = true;

      try{
        setStatus("–®—É–∫–∞—é –≤ –±–∞–∑—ñ‚Ä¶");
        sendBtn.disabled = true;

        addMsg(text, "user");
        promptEl.value = "";
        autoResize();

        if (!ragEnabled){
          addMsg("üîé –ü–æ—à—É–∫ –≤–∏–º–∫–Ω–µ–Ω–æ. –£–≤—ñ–º–∫–Ω–∏ –π–æ–≥–æ, —â–æ–± –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—Ç–∏ –∑ –±–∞–∑–∏.", "bot");
          setStatus("–ì–æ—Ç–æ–≤–æ");
          return;
        }

        // ‚úÖ –ë–ê–ó–û–í–ê –í–Ü–î–ü–û–í–Ü–î–¨ –∑ KB
        let answer = KBIndex.answer(text);
        answer = stripNoiseLines(answer);

        // ‚úÖ —è–∫—â–æ LLM –≤–∏–º–∫–Ω–µ–Ω–∏–π ‚Äî —è–∫ –±—É–ª–æ
        if (!llmEnabled){
          addMsg(answer, "bot");
          setStatus("–ì–æ—Ç–æ–≤–æ");
          return;
        }

        // ‚úÖ —è–∫—â–æ –±–∞–∑–∞ –Ω–µ –∑–Ω–∞–π—à–ª–∞/–ø–æ–º–∏–ª–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏ ‚Äî –Ω–µ –≤–∏–∫–ª–∏–∫–∞—î–º–æ LLM
        if (/–Ω–µ –∑–Ω–∞–π—à–æ–≤|–Ω–µ–º–∞—î|—Å—Ç—Ä—É–∫—Ç—É—Ä–æ–≤–∞–Ω–∏—Ö –±–ª–æ–∫—ñ–≤/i.test(answer)){
          addMsg(answer, "bot");
          setStatus("–ì–æ—Ç–æ–≤–æ");
          return;
        }

        // ‚úÖ –∫–æ—Ä–æ—Ç–∫–∏–π —Ä–µ–∂–∏–º (1-2 —Å–ª–æ–≤–∞)
        const qToks = tokensOf(text);
        const shortMode =
          qToks.length <= 2 &&
          normalize(text).length <= 22 &&
          !text.includes("?");

        setStatus("–£—Ç–æ—á–Ω—é—é –≤—ñ–¥–ø–æ–≤—ñ–¥—å —á–µ—Ä–µ–∑ LLM‚Ä¶");

        const llmAnswer = await callLLM({
          question: text,
          context: answer,
          shortMode
        });

        addMsg(stripNoiseLines(llmAnswer || answer), "bot");
        setStatus("–ì–æ—Ç–æ–≤–æ");
        return;

      }catch(err){
        addMsg("‚ùå –ü–æ–º–∏–ª–∫–∞: " + (err?.message || String(err)), "bot");
        setStatus("–ü–æ–º–∏–ª–∫–∞");
      }finally{
        sendBtn.disabled = false;
        sendingLock = false;
      }
    }

    async function init(){
      attachSendHandlersOnce();

      renderKB();
      KBIndex.rebuildFromKB();
      autoResize();
      setStatus("–ì–æ—Ç–æ–≤–æ");

      if (KB.getAll().length === 0) {
        addMsg("–î–æ–¥–∞–π **biology_basics.txt** —á–µ—Ä–µ–∑ ‚Äú+‚Äù –∞–±–æ –ø–æ–∫–ª–∞–¥–∏ —Ñ–∞–π–ª —É data/raw.", "bot");
        return;
      }

      const docs = KB.getAll();
      const bio = docs.find(d => d.title === "biology_basics.txt");
      if (bio){
        const hasGroups = /–ì–†–£–ü–ê –ó–ê–ü–ò–¢–£:/i.test(bio.text) && /–ö–ª—é—á–æ–≤—ñ —Å–ª–æ–≤–∞:/i.test(bio.text) && /–í—ñ–¥–ø–æ–≤—ñ–¥—å:/i.test(bio.text);
        if (!hasGroups){
          addMsg(
            "‚ö†Ô∏è –£ **biology_basics.txt** –Ω–µ –±–∞—á—É —Å—Ç—Ä—É–∫—Ç—É—Ä–∏ –¥–ª—è –ø–æ—à—É–∫—É.\n" +
            "–§–∞–π–ª –º–∞—î –º—ñ—Å—Ç–∏—Ç–∏ –±–ª–æ–∫–∏: **–ì–†–£–ü–ê –ó–ê–ü–ò–¢–£ / –ö–ª—é—á–æ–≤—ñ —Å–ª–æ–≤–∞ / –í—ñ–¥–ø–æ–≤—ñ–¥—å**.",
            "bot"
          );
        }
      }
    }
    init();
  </script>
</body>
</html>
